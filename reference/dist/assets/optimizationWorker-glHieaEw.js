function bs(f,c,a={}){const{minCutWidth:p=0,maxCutWidth:y=0,minCutDepth:_=0,maxCutDepth:k=0,maxLengthTrim:b=0,maxLengthExtend:S=0}=a,j=0,F=f.L/2,T=_>0?Math.max(f.hMin,f.h0-_):f.h0,R=k>0?Math.max(f.hMin,f.h0-k):f.hMin;return{lambdaMin:j,lambdaMax:F,hMin:R,hMax:T,minCutWidth:p,maxCutWidth:y,minCutDepth:_,maxCutDepth:k,maxLengthTrim:b,maxLengthExtend:S}}function Ms(f,c,a){const p=[];for(let _=0;_<f;_++)p.push(0),p.push(a);return(c.maxLengthTrim>0||c.maxLengthExtend>0)&&p.push(0),{genes:p,fitness:1/0}}function Es(f,c){const a=[],p=c.minCutWidth||0,y=c.maxCutWidth||0,_=[];if(f===1){let b=c.lambdaMin+Math.random()*(c.lambdaMax-c.lambdaMin);y>0&&(b=Math.min(b,y)),_.push(b)}else{let b=c.lambdaMax;for(let S=0;S<f;S++){const F=(f-S-1)*p,T=b-F;let R=c.lambdaMin+F,W=T;y>0&&S>0&&(R=Math.max(R,_[S-1]-y)),W<R&&(W=R);const z=R+Math.random()*(W-R);_.push(z),b=z-p}}_.sort((b,S)=>S-b);for(let b=0;b<f;b++){a.push(_[b]);const S=c.hMin+Math.random()*(c.hMax-c.hMin);a.push(S)}if(c.maxLengthTrim>0||c.maxLengthExtend>0){const b=-c.maxLengthExtend,S=c.maxLengthTrim,j=b+Math.random()*(S-b);a.push(j)}return{genes:a,fitness:1/0}}function Ss(f,c,a,p){const y=[];if(p&&p.length>0){const _=Nt(p,a);y.push({genes:_,fitness:1/0});const k=Math.min(Math.floor(f*.2),10);for(let b=0;b<k&&y.length<f;b++){const S=_.map(j=>j*(.95+Math.random()*.1));y.push({genes:Nt(S,a),fitness:1/0})}}for(;y.length<f;)y.push(Es(c,a));return y}function Me(f){return f.reduce((c,a)=>a.fitness<c.fitness?a:c)}function _s(f){const c=f.map(S=>S.fitness).filter(S=>isFinite(S));if(c.length===0)return{bestFitness:1/0,worstFitness:1/0,averageFitness:1/0,medianFitness:1/0,standardDeviation:0};c.sort((S,j)=>S-j);const p=c.reduce((S,j)=>S+j,0)/c.length,y=c.length%2===0?(c[c.length/2-1]+c[c.length/2])/2:c[Math.floor(c.length/2)],k=c.map(S=>(S-p)**2).reduce((S,j)=>S+j,0)/c.length,b=Math.sqrt(k);return{bestFitness:c[0],worstFitness:c[c.length-1],averageFitness:p,medianFitness:y,standardDeviation:b}}function Ee(f){return{genes:[...f.genes],fitness:f.fitness,sigmas:f.sigmas?[...f.sigmas]:void 0}}function Nt(f,c){const a=[...f],p=c.minCutWidth||0,y=c.maxCutWidth||0,_=c.maxLengthTrim>0||c.maxLengthExtend>0,k=_?(a.length-1)/2:a.length/2,b=k*2;for(let S=0;S<b;S+=2)a[S]=Math.max(c.lambdaMin,Math.min(c.lambdaMax,a[S])),a[S+1]=Math.max(c.hMin,Math.min(c.hMax,a[S+1]));if(_&&a.length>b){const S=-c.maxLengthExtend,j=c.maxLengthTrim;a[b]=Math.max(S,Math.min(j,a[b]))}if((p>0||y>0)&&k>=1){const S=[];for(let j=0;j<k;j++)S.push({lambda:a[j*2],idx:j*2});S.sort((j,F)=>F.lambda-j.lambda);for(let j=1;j<S.length;j++){const F=S[j-1].lambda;let T=S[j].lambda;if(p>0){const R=F-p;T>R&&(T=Math.max(c.lambdaMin,R))}if(y>0){const R=F-y;T<R&&(T=Math.max(c.lambdaMin,R))}S[j].lambda=T}for(const j of S)a[j.idx]=j.lambda}return a}function ge(f,c){const a=c*2;return f.length>a?f[a]:0}function js(f,c){return f/(2*(1+c))}const vs=5/6;function ks(f,c,a,p,y,_){const k=a*c,b=a*c*c*c/12,S=js(p,_),j=vs,F=12*p*b/(j*S*k*f*f),T=p*b,R=f,W=R*R,z=R*R*R,$=1+F,A=[[12*T/(z*$),6*T/(W*$),-12*T/(z*$),6*T/(W*$)],[6*T/(W*$),(4+F)*T/(R*$),-6*T/(W*$),(2-F)*T/(R*$)],[-12*T/(z*$),-6*T/(W*$),12*T/(z*$),-6*T/(W*$)],[6*T/(W*$),(2-F)*T/(R*$),-6*T/(W*$),(4+F)*T/(R*$)]],X=y*k,J=y*b,tt=X*R/420,ut=J/(30*R),K=156*tt,ht=22*R*tt,Ft=54*tt,gt=-13*R*tt,bt=4*R*R*tt+36*ut,Mt=3*R*R*tt-36*ut,mt=[[K,ht,Ft,gt],[ht,bt,-gt,Mt],[Ft,-gt,K,-ht],[gt,Mt,-ht,bt]],Tt=F*F,It=(1+F)*(1+F),at=mt.map((wt,Et)=>wt.map((Rt,Lt)=>Rt/It+(F>.01?Tt*X*R*(Et===Lt?.01:0):0)));return{Ke:A,Me:at}}function Ts(f,c,a,p,y,_){const k=new Map;return f.map(b=>{const S=Math.round(b*1e8)/1e8;if(k.has(S))return k.get(S);const j=ks(c,b,a,p,y,_);return k.set(S,j),j})}function xt(f,c,a,p){const y=Math.abs(f-a/2),k=[...c].sort((b,S)=>S.lambda-b.lambda).filter(b=>b.lambda>0&&y<=b.lambda);return k.length===0?p:k[k.length-1].h}function Is(f,c,a,p){const y=c/p,_=[],k=c/2,b=[...f].sort((j,F)=>F.lambda-j.lambda),S=[];for(const j of b){if(j.lambda<=0)continue;const F=k-j.lambda,T=k+j.lambda,R=xt(F-1e-4,b,c,a),W=xt(F+1e-4,b,c,a);Math.abs(R-W)>1e-9&&S.push({pos:F,hBefore:R,hAfter:W});const z=xt(T-1e-4,b,c,a),$=xt(T+1e-4,b,c,a);Math.abs(z-$)>1e-9&&S.push({pos:T,hBefore:z,hAfter:$})}S.sort((j,F)=>j.pos-F.pos);for(let j=0;j<p;j++){const F=j*y,T=(j+1)*y,R=(F+T)/2;let W=!1;for(const z of S)if(z.pos>F&&z.pos<T){const $=z.pos-F,A=T-z.pos,X=z.hBefore,J=z.hAfter;_.push(Math.sqrt((X*X*$+J*J*A)/($+A))),W=!0;break}W||_.push(xt(R,b,c,a))}return _}function se(f){const c=[];for(let a=0;a+1<f.length;a+=2){const p=f[a],y=f[a+1];typeof p=="number"&&typeof y=="number"&&!isNaN(p)&&!isNaN(y)&&c.push({lambda:p,h:y})}return c.sort((a,p)=>p.lambda-a.lambda)}function Rs(f,c,a,p,y,_){const k=f.length,S=(k+1)*2,j=Array(S).fill(null).map(()=>Array(S).fill(0)),F=Array(S).fill(null).map(()=>Array(S).fill(0)),T=Ts(f,c,a,p,y,_);for(let R=0;R<k;R++){const{Ke:W,Me:z}=T[R],$=[2*R,2*R+1,2*(R+1),2*(R+1)+1];for(let A=0;A<4;A++){const X=$[A];for(let J=0;J<4;J++){const tt=$[J];j[X][tt]+=W[A][J],F[X][tt]+=z[A][J]}}}return{K:j,M:F,numDOF:S}}function Cs(f,c,a,p){const y=Is(f,c.L,c.h0,p),_=c.L/p;return Rs(y,_,c.b,a.E,a.rho,a.nu)}function Fs(f){return f&&f.__esModule&&Object.prototype.hasOwnProperty.call(f,"default")?f.default:f}function Ce(f){if(Object.prototype.hasOwnProperty.call(f,"__esModule"))return f;var c=f.default;if(typeof c=="function"){var a=function p(){var y=!1;try{y=this instanceof p}catch{}return y?Reflect.construct(c,arguments,this.constructor):c.apply(this,arguments)};a.prototype=c.prototype}else a={};return Object.defineProperty(a,"__esModule",{value:!0}),Object.keys(f).forEach(function(p){var y=Object.getOwnPropertyDescriptor(f,p);Object.defineProperty(a,p,y.get?y:{enumerable:!0,get:function(){return f[p]}})}),a}var Y={};const Ls=Object.prototype.toString;function Bt(f){const c=Ls.call(f);return c.endsWith("Array]")&&!c.includes("Big")}var qs=Object.freeze({__proto__:null,isAnyArray:Bt}),Ps=Ce(qs);function Ns(f){var c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Bt(f))throw new TypeError("input must be an array");if(f.length===0)throw new TypeError("input must not be empty");var a=c.fromIndex,p=a===void 0?0:a,y=c.toIndex,_=y===void 0?f.length:y;if(p<0||p>=f.length||!Number.isInteger(p))throw new Error("fromIndex must be a positive integer smaller than length");if(_<=p||_>f.length||!Number.isInteger(_))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var k=f[p],b=p+1;b<_;b++)f[b]>k&&(k=f[b]);return k}function Ds(f){var c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Bt(f))throw new TypeError("input must be an array");if(f.length===0)throw new TypeError("input must not be empty");var a=c.fromIndex,p=a===void 0?0:a,y=c.toIndex,_=y===void 0?f.length:y;if(p<0||p>=f.length||!Number.isInteger(p))throw new Error("fromIndex must be a positive integer smaller than length");if(_<=p||_>f.length||!Number.isInteger(_))throw new Error("toIndex must be an integer greater than fromIndex and at most equal to length");for(var k=f[p],b=p+1;b<_;b++)f[b]<k&&(k=f[b]);return k}function xs(f){var c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(Bt(f)){if(f.length===0)throw new TypeError("input must not be empty")}else throw new TypeError("input must be an array");var a;if(c.output!==void 0){if(!Bt(c.output))throw new TypeError("output option must be an array if specified");a=c.output}else a=new Array(f.length);var p=Ds(f),y=Ns(f);if(p===y)throw new RangeError("minimum and maximum input values are equal. Cannot rescale a constant array");var _=c.min,k=_===void 0?c.autoMinMax?p:0:_,b=c.max,S=b===void 0?c.autoMinMax?y:1:b;if(k>=S)throw new RangeError("min option must be smaller than max option");for(var j=(S-k)/(y-p),F=0;F<f.length;F++)a[F]=(f[F]-p)*j+k;return a}var Ws=Object.freeze({__proto__:null,default:xs}),zs=Ce(Ws),Se;function Os(){if(Se)return Y;Se=1,Object.defineProperty(Y,"__esModule",{value:!0});var f=Ps,c=zs;const a=" ".repeat(2),p=" ".repeat(4);function y(){return _(this)}function _(r,e={}){const{maxRows:s=15,maxColumns:t=10,maxNumSize:n=8,padMinus:o="auto"}=e;return`${r.constructor.name} {
${a}[
${p}${k(r,s,t,n,o)}
${a}]
${a}rows: ${r.rows}
${a}columns: ${r.columns}
}`}function k(r,e,s,t,n){const{rows:o,columns:i}=r,l=Math.min(o,e),u=Math.min(i,s),h=[];if(n==="auto"){n=!1;t:for(let d=0;d<l;d++)for(let g=0;g<u;g++)if(r.get(d,g)<0){n=!0;break t}}for(let d=0;d<l;d++){let g=[];for(let E=0;E<u;E++)g.push(b(r.get(d,E),t,n));h.push(`${g.join(" ")}`)}return u!==i&&(h[h.length-1]+=` ... ${i-s} more columns`),l!==o&&h.push(`... ${o-e} more rows`),h.join(`
${p}`)}function b(r,e,s){return(r>=0&&s?` ${S(r,e-1)}`:S(r,e)).padEnd(e)}function S(r,e){let s=r.toString();if(s.length<=e)return s;let t=r.toFixed(e);if(t.length>e&&(t=r.toFixed(Math.max(0,e-(t.length-e)))),t.length<=e&&!t.startsWith("0.000")&&!t.startsWith("-0.000"))return t;let n=r.toExponential(e);return n.length>e&&(n=r.toExponential(Math.max(0,e-(n.length-e)))),n.slice(0)}function j(r,e){r.prototype.add=function(t){return typeof t=="number"?this.addS(t):this.addM(t)},r.prototype.addS=function(t){for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)+t);return this},r.prototype.addM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)+t.get(n,o));return this},r.add=function(t,n){return new e(t).add(n)},r.prototype.sub=function(t){return typeof t=="number"?this.subS(t):this.subM(t)},r.prototype.subS=function(t){for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)-t);return this},r.prototype.subM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)-t.get(n,o));return this},r.sub=function(t,n){return new e(t).sub(n)},r.prototype.subtract=r.prototype.sub,r.prototype.subtractS=r.prototype.subS,r.prototype.subtractM=r.prototype.subM,r.subtract=r.sub,r.prototype.mul=function(t){return typeof t=="number"?this.mulS(t):this.mulM(t)},r.prototype.mulS=function(t){for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)*t);return this},r.prototype.mulM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)*t.get(n,o));return this},r.mul=function(t,n){return new e(t).mul(n)},r.prototype.multiply=r.prototype.mul,r.prototype.multiplyS=r.prototype.mulS,r.prototype.multiplyM=r.prototype.mulM,r.multiply=r.mul,r.prototype.div=function(t){return typeof t=="number"?this.divS(t):this.divM(t)},r.prototype.divS=function(t){for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)/t);return this},r.prototype.divM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)/t.get(n,o));return this},r.div=function(t,n){return new e(t).div(n)},r.prototype.divide=r.prototype.div,r.prototype.divideS=r.prototype.divS,r.prototype.divideM=r.prototype.divM,r.divide=r.div,r.prototype.mod=function(t){return typeof t=="number"?this.modS(t):this.modM(t)},r.prototype.modS=function(t){for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)%t);return this},r.prototype.modM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)%t.get(n,o));return this},r.mod=function(t,n){return new e(t).mod(n)},r.prototype.modulus=r.prototype.mod,r.prototype.modulusS=r.prototype.modS,r.prototype.modulusM=r.prototype.modM,r.modulus=r.mod,r.prototype.and=function(t){return typeof t=="number"?this.andS(t):this.andM(t)},r.prototype.andS=function(t){for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)&t);return this},r.prototype.andM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)&t.get(n,o));return this},r.and=function(t,n){return new e(t).and(n)},r.prototype.or=function(t){return typeof t=="number"?this.orS(t):this.orM(t)},r.prototype.orS=function(t){for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)|t);return this},r.prototype.orM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)|t.get(n,o));return this},r.or=function(t,n){return new e(t).or(n)},r.prototype.xor=function(t){return typeof t=="number"?this.xorS(t):this.xorM(t)},r.prototype.xorS=function(t){for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)^t);return this},r.prototype.xorM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)^t.get(n,o));return this},r.xor=function(t,n){return new e(t).xor(n)},r.prototype.leftShift=function(t){return typeof t=="number"?this.leftShiftS(t):this.leftShiftM(t)},r.prototype.leftShiftS=function(t){for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)<<t);return this},r.prototype.leftShiftM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)<<t.get(n,o));return this},r.leftShift=function(t,n){return new e(t).leftShift(n)},r.prototype.signPropagatingRightShift=function(t){return typeof t=="number"?this.signPropagatingRightShiftS(t):this.signPropagatingRightShiftM(t)},r.prototype.signPropagatingRightShiftS=function(t){for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)>>t);return this},r.prototype.signPropagatingRightShiftM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)>>t.get(n,o));return this},r.signPropagatingRightShift=function(t,n){return new e(t).signPropagatingRightShift(n)},r.prototype.rightShift=function(t){return typeof t=="number"?this.rightShiftS(t):this.rightShiftM(t)},r.prototype.rightShiftS=function(t){for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)>>>t);return this},r.prototype.rightShiftM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)>>>t.get(n,o));return this},r.rightShift=function(t,n){return new e(t).rightShift(n)},r.prototype.zeroFillRightShift=r.prototype.rightShift,r.prototype.zeroFillRightShiftS=r.prototype.rightShiftS,r.prototype.zeroFillRightShiftM=r.prototype.rightShiftM,r.zeroFillRightShift=r.rightShift,r.prototype.not=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,~this.get(t,n));return this},r.not=function(t){return new e(t).not()},r.prototype.abs=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.abs(this.get(t,n)));return this},r.abs=function(t){return new e(t).abs()},r.prototype.acos=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.acos(this.get(t,n)));return this},r.acos=function(t){return new e(t).acos()},r.prototype.acosh=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.acosh(this.get(t,n)));return this},r.acosh=function(t){return new e(t).acosh()},r.prototype.asin=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.asin(this.get(t,n)));return this},r.asin=function(t){return new e(t).asin()},r.prototype.asinh=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.asinh(this.get(t,n)));return this},r.asinh=function(t){return new e(t).asinh()},r.prototype.atan=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.atan(this.get(t,n)));return this},r.atan=function(t){return new e(t).atan()},r.prototype.atanh=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.atanh(this.get(t,n)));return this},r.atanh=function(t){return new e(t).atanh()},r.prototype.cbrt=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.cbrt(this.get(t,n)));return this},r.cbrt=function(t){return new e(t).cbrt()},r.prototype.ceil=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.ceil(this.get(t,n)));return this},r.ceil=function(t){return new e(t).ceil()},r.prototype.clz32=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.clz32(this.get(t,n)));return this},r.clz32=function(t){return new e(t).clz32()},r.prototype.cos=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.cos(this.get(t,n)));return this},r.cos=function(t){return new e(t).cos()},r.prototype.cosh=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.cosh(this.get(t,n)));return this},r.cosh=function(t){return new e(t).cosh()},r.prototype.exp=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.exp(this.get(t,n)));return this},r.exp=function(t){return new e(t).exp()},r.prototype.expm1=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.expm1(this.get(t,n)));return this},r.expm1=function(t){return new e(t).expm1()},r.prototype.floor=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.floor(this.get(t,n)));return this},r.floor=function(t){return new e(t).floor()},r.prototype.fround=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.fround(this.get(t,n)));return this},r.fround=function(t){return new e(t).fround()},r.prototype.log=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.log(this.get(t,n)));return this},r.log=function(t){return new e(t).log()},r.prototype.log1p=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.log1p(this.get(t,n)));return this},r.log1p=function(t){return new e(t).log1p()},r.prototype.log10=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.log10(this.get(t,n)));return this},r.log10=function(t){return new e(t).log10()},r.prototype.log2=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.log2(this.get(t,n)));return this},r.log2=function(t){return new e(t).log2()},r.prototype.round=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.round(this.get(t,n)));return this},r.round=function(t){return new e(t).round()},r.prototype.sign=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.sign(this.get(t,n)));return this},r.sign=function(t){return new e(t).sign()},r.prototype.sin=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.sin(this.get(t,n)));return this},r.sin=function(t){return new e(t).sin()},r.prototype.sinh=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.sinh(this.get(t,n)));return this},r.sinh=function(t){return new e(t).sinh()},r.prototype.sqrt=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.sqrt(this.get(t,n)));return this},r.sqrt=function(t){return new e(t).sqrt()},r.prototype.tan=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.tan(this.get(t,n)));return this},r.tan=function(t){return new e(t).tan()},r.prototype.tanh=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.tanh(this.get(t,n)));return this},r.tanh=function(t){return new e(t).tanh()},r.prototype.trunc=function(){for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.set(t,n,Math.trunc(this.get(t,n)));return this},r.trunc=function(t){return new e(t).trunc()},r.pow=function(t,n){return new e(t).pow(n)},r.prototype.pow=function(t){return typeof t=="number"?this.powS(t):this.powM(t)},r.prototype.powS=function(t){for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)**t);return this},r.prototype.powM=function(t){if(t=e.checkMatrix(t),this.rows!==t.rows||this.columns!==t.columns)throw new RangeError("Matrices dimensions must be equal");for(let n=0;n<this.rows;n++)for(let o=0;o<this.columns;o++)this.set(n,o,this.get(n,o)**t.get(n,o));return this}}function F(r,e,s){let t=s?r.rows:r.rows-1;if(e<0||e>t)throw new RangeError("Row index out of range")}function T(r,e,s){let t=s?r.columns:r.columns-1;if(e<0||e>t)throw new RangeError("Column index out of range")}function R(r,e){if(e.to1DArray&&(e=e.to1DArray()),e.length!==r.columns)throw new RangeError("vector size must be the same as the number of columns");return e}function W(r,e){if(e.to1DArray&&(e=e.to1DArray()),e.length!==r.rows)throw new RangeError("vector size must be the same as the number of rows");return e}function z(r,e){if(!f.isAnyArray(e))throw new TypeError("row indices must be an array");for(let s=0;s<e.length;s++)if(e[s]<0||e[s]>=r.rows)throw new RangeError("row indices are out of range")}function $(r,e){if(!f.isAnyArray(e))throw new TypeError("column indices must be an array");for(let s=0;s<e.length;s++)if(e[s]<0||e[s]>=r.columns)throw new RangeError("column indices are out of range")}function A(r,e,s,t,n){if(arguments.length!==5)throw new RangeError("expected 4 arguments");if(J("startRow",e),J("endRow",s),J("startColumn",t),J("endColumn",n),e>s||t>n||e<0||e>=r.rows||s<0||s>=r.rows||t<0||t>=r.columns||n<0||n>=r.columns)throw new RangeError("Submatrix indices are out of range")}function X(r,e=0){let s=[];for(let t=0;t<r;t++)s.push(e);return s}function J(r,e){if(typeof e!="number")throw new TypeError(`${r} must be a number`)}function tt(r){if(r.isEmpty())throw new Error("Empty matrix has no elements to index")}function ut(r){let e=X(r.rows);for(let s=0;s<r.rows;++s)for(let t=0;t<r.columns;++t)e[s]+=r.get(s,t);return e}function K(r){let e=X(r.columns);for(let s=0;s<r.rows;++s)for(let t=0;t<r.columns;++t)e[t]+=r.get(s,t);return e}function ht(r){let e=0;for(let s=0;s<r.rows;s++)for(let t=0;t<r.columns;t++)e+=r.get(s,t);return e}function Ft(r){let e=X(r.rows,1);for(let s=0;s<r.rows;++s)for(let t=0;t<r.columns;++t)e[s]*=r.get(s,t);return e}function gt(r){let e=X(r.columns,1);for(let s=0;s<r.rows;++s)for(let t=0;t<r.columns;++t)e[t]*=r.get(s,t);return e}function bt(r){let e=1;for(let s=0;s<r.rows;s++)for(let t=0;t<r.columns;t++)e*=r.get(s,t);return e}function Mt(r,e,s){const t=r.rows,n=r.columns,o=[];for(let i=0;i<t;i++){let l=0,u=0,h=0;for(let d=0;d<n;d++)h=r.get(i,d)-s[i],l+=h,u+=h*h;e?o.push((u-l*l/n)/(n-1)):o.push((u-l*l/n)/n)}return o}function mt(r,e,s){const t=r.rows,n=r.columns,o=[];for(let i=0;i<n;i++){let l=0,u=0,h=0;for(let d=0;d<t;d++)h=r.get(d,i)-s[i],l+=h,u+=h*h;e?o.push((u-l*l/t)/(t-1)):o.push((u-l*l/t)/t)}return o}function Tt(r,e,s){const t=r.rows,n=r.columns,o=t*n;let i=0,l=0,u=0;for(let h=0;h<t;h++)for(let d=0;d<n;d++)u=r.get(h,d)-s,i+=u,l+=u*u;return e?(l-i*i/o)/(o-1):(l-i*i/o)/o}function It(r,e){for(let s=0;s<r.rows;s++)for(let t=0;t<r.columns;t++)r.set(s,t,r.get(s,t)-e[s])}function at(r,e){for(let s=0;s<r.rows;s++)for(let t=0;t<r.columns;t++)r.set(s,t,r.get(s,t)-e[t])}function wt(r,e){for(let s=0;s<r.rows;s++)for(let t=0;t<r.columns;t++)r.set(s,t,r.get(s,t)-e)}function Et(r){const e=[];for(let s=0;s<r.rows;s++){let t=0;for(let n=0;n<r.columns;n++)t+=r.get(s,n)**2/(r.columns-1);e.push(Math.sqrt(t))}return e}function Rt(r,e){for(let s=0;s<r.rows;s++)for(let t=0;t<r.columns;t++)r.set(s,t,r.get(s,t)/e[s])}function Lt(r){const e=[];for(let s=0;s<r.columns;s++){let t=0;for(let n=0;n<r.rows;n++)t+=r.get(n,s)**2/(r.rows-1);e.push(Math.sqrt(t))}return e}function re(r,e){for(let s=0;s<r.rows;s++)for(let t=0;t<r.columns;t++)r.set(s,t,r.get(s,t)/e[t])}function $e(r){const e=r.size-1;let s=0;for(let t=0;t<r.columns;t++)for(let n=0;n<r.rows;n++)s+=r.get(n,t)**2/e;return Math.sqrt(s)}function Be(r,e){for(let s=0;s<r.rows;s++)for(let t=0;t<r.columns;t++)r.set(s,t,r.get(s,t)/e)}class U{static from1DArray(e,s,t){if(e*s!==t.length)throw new RangeError("data length does not match given dimensions");let o=new P(e,s);for(let i=0;i<e;i++)for(let l=0;l<s;l++)o.set(i,l,t[i*s+l]);return o}static rowVector(e){let s=new P(1,e.length);for(let t=0;t<e.length;t++)s.set(0,t,e[t]);return s}static columnVector(e){let s=new P(e.length,1);for(let t=0;t<e.length;t++)s.set(t,0,e[t]);return s}static zeros(e,s){return new P(e,s)}static ones(e,s){return new P(e,s).fill(1)}static rand(e,s,t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{random:n=Math.random}=t;let o=new P(e,s);for(let i=0;i<e;i++)for(let l=0;l<s;l++)o.set(i,l,n());return o}static randInt(e,s,t={}){if(typeof t!="object")throw new TypeError("options must be an object");const{min:n=0,max:o=1e3,random:i=Math.random}=t;if(!Number.isInteger(n))throw new TypeError("min must be an integer");if(!Number.isInteger(o))throw new TypeError("max must be an integer");if(n>=o)throw new RangeError("min must be smaller than max");let l=o-n,u=new P(e,s);for(let h=0;h<e;h++)for(let d=0;d<s;d++){let g=n+Math.round(i()*l);u.set(h,d,g)}return u}static eye(e,s,t){s===void 0&&(s=e),t===void 0&&(t=1);let n=Math.min(e,s),o=this.zeros(e,s);for(let i=0;i<n;i++)o.set(i,i,t);return o}static diag(e,s,t){let n=e.length;s===void 0&&(s=n),t===void 0&&(t=s);let o=Math.min(n,s,t),i=this.zeros(s,t);for(let l=0;l<o;l++)i.set(l,l,e[l]);return i}static min(e,s){e=this.checkMatrix(e),s=this.checkMatrix(s);let t=e.rows,n=e.columns,o=new P(t,n);for(let i=0;i<t;i++)for(let l=0;l<n;l++)o.set(i,l,Math.min(e.get(i,l),s.get(i,l)));return o}static max(e,s){e=this.checkMatrix(e),s=this.checkMatrix(s);let t=e.rows,n=e.columns,o=new this(t,n);for(let i=0;i<t;i++)for(let l=0;l<n;l++)o.set(i,l,Math.max(e.get(i,l),s.get(i,l)));return o}static checkMatrix(e){return U.isMatrix(e)?e:new P(e)}static isMatrix(e){return e!=null&&e.klass==="Matrix"}get size(){return this.rows*this.columns}apply(e){if(typeof e!="function")throw new TypeError("callback must be a function");for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)e.call(this,s,t);return this}to1DArray(){let e=[];for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)e.push(this.get(s,t));return e}to2DArray(){let e=[];for(let s=0;s<this.rows;s++){e.push([]);for(let t=0;t<this.columns;t++)e[s].push(this.get(s,t))}return e}toJSON(){return this.to2DArray()}isRowVector(){return this.rows===1}isColumnVector(){return this.columns===1}isVector(){return this.rows===1||this.columns===1}isSquare(){return this.rows===this.columns}isEmpty(){return this.rows===0||this.columns===0}isSymmetric(){if(this.isSquare()){for(let e=0;e<this.rows;e++)for(let s=0;s<=e;s++)if(this.get(e,s)!==this.get(s,e))return!1;return!0}return!1}isDistance(){if(!this.isSymmetric())return!1;for(let e=0;e<this.rows;e++)if(this.get(e,e)!==0)return!1;return!0}isEchelonForm(){let e=0,s=0,t=-1,n=!0,o=!1;for(;e<this.rows&&n;){for(s=0,o=!1;s<this.columns&&o===!1;)this.get(e,s)===0?s++:this.get(e,s)===1&&s>t?(o=!0,t=s):(n=!1,o=!0);e++}return n}isReducedEchelonForm(){let e=0,s=0,t=-1,n=!0,o=!1;for(;e<this.rows&&n;){for(s=0,o=!1;s<this.columns&&o===!1;)this.get(e,s)===0?s++:this.get(e,s)===1&&s>t?(o=!0,t=s):(n=!1,o=!0);for(let i=s+1;i<this.rows;i++)this.get(e,i)!==0&&(n=!1);e++}return n}echelonForm(){let e=this.clone(),s=0,t=0;for(;s<e.rows&&t<e.columns;){let n=s;for(let o=s;o<e.rows;o++)e.get(o,t)>e.get(n,t)&&(n=o);if(e.get(n,t)===0)t++;else{e.swapRows(s,n);let o=e.get(s,t);for(let i=t;i<e.columns;i++)e.set(s,i,e.get(s,i)/o);for(let i=s+1;i<e.rows;i++){let l=e.get(i,t)/e.get(s,t);e.set(i,t,0);for(let u=t+1;u<e.columns;u++)e.set(i,u,e.get(i,u)-e.get(s,u)*l)}s++,t++}}return e}reducedEchelonForm(){let e=this.echelonForm(),s=e.columns,t=e.rows,n=t-1;for(;n>=0;)if(e.maxRow(n)===0)n--;else{let o=0,i=!1;for(;o<t&&i===!1;)e.get(n,o)===1?i=!0:o++;for(let l=0;l<n;l++){let u=e.get(l,o);for(let h=o;h<s;h++){let d=e.get(l,h)-u*e.get(n,h);e.set(l,h,d)}}n--}return e}set(){throw new Error("set method is unimplemented")}get(){throw new Error("get method is unimplemented")}repeat(e={}){if(typeof e!="object")throw new TypeError("options must be an object");const{rows:s=1,columns:t=1}=e;if(!Number.isInteger(s)||s<=0)throw new TypeError("rows must be a positive integer");if(!Number.isInteger(t)||t<=0)throw new TypeError("columns must be a positive integer");let n=new P(this.rows*s,this.columns*t);for(let o=0;o<s;o++)for(let i=0;i<t;i++)n.setSubMatrix(this,this.rows*o,this.columns*i);return n}fill(e){for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)this.set(s,t,e);return this}neg(){return this.mulS(-1)}getRow(e){F(this,e);let s=[];for(let t=0;t<this.columns;t++)s.push(this.get(e,t));return s}getRowVector(e){return P.rowVector(this.getRow(e))}setRow(e,s){F(this,e),s=R(this,s);for(let t=0;t<this.columns;t++)this.set(e,t,s[t]);return this}swapRows(e,s){F(this,e),F(this,s);for(let t=0;t<this.columns;t++){let n=this.get(e,t);this.set(e,t,this.get(s,t)),this.set(s,t,n)}return this}getColumn(e){T(this,e);let s=[];for(let t=0;t<this.rows;t++)s.push(this.get(t,e));return s}getColumnVector(e){return P.columnVector(this.getColumn(e))}setColumn(e,s){T(this,e),s=W(this,s);for(let t=0;t<this.rows;t++)this.set(t,e,s[t]);return this}swapColumns(e,s){T(this,e),T(this,s);for(let t=0;t<this.rows;t++){let n=this.get(t,e);this.set(t,e,this.get(t,s)),this.set(t,s,n)}return this}addRowVector(e){e=R(this,e);for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)this.set(s,t,this.get(s,t)+e[t]);return this}subRowVector(e){e=R(this,e);for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)this.set(s,t,this.get(s,t)-e[t]);return this}mulRowVector(e){e=R(this,e);for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)this.set(s,t,this.get(s,t)*e[t]);return this}divRowVector(e){e=R(this,e);for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)this.set(s,t,this.get(s,t)/e[t]);return this}addColumnVector(e){e=W(this,e);for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)this.set(s,t,this.get(s,t)+e[s]);return this}subColumnVector(e){e=W(this,e);for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)this.set(s,t,this.get(s,t)-e[s]);return this}mulColumnVector(e){e=W(this,e);for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)this.set(s,t,this.get(s,t)*e[s]);return this}divColumnVector(e){e=W(this,e);for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)this.set(s,t,this.get(s,t)/e[s]);return this}mulRow(e,s){F(this,e);for(let t=0;t<this.columns;t++)this.set(e,t,this.get(e,t)*s);return this}mulColumn(e,s){T(this,e);for(let t=0;t<this.rows;t++)this.set(t,e,this.get(t,e)*s);return this}max(e){if(this.isEmpty())return NaN;switch(e){case"row":{const s=new Array(this.rows).fill(Number.NEGATIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.get(t,n)>s[t]&&(s[t]=this.get(t,n));return s}case"column":{const s=new Array(this.columns).fill(Number.NEGATIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.get(t,n)>s[n]&&(s[n]=this.get(t,n));return s}case void 0:{let s=this.get(0,0);for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.get(t,n)>s&&(s=this.get(t,n));return s}default:throw new Error(`invalid option: ${e}`)}}maxIndex(){tt(this);let e=this.get(0,0),s=[0,0];for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.get(t,n)>e&&(e=this.get(t,n),s[0]=t,s[1]=n);return s}min(e){if(this.isEmpty())return NaN;switch(e){case"row":{const s=new Array(this.rows).fill(Number.POSITIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.get(t,n)<s[t]&&(s[t]=this.get(t,n));return s}case"column":{const s=new Array(this.columns).fill(Number.POSITIVE_INFINITY);for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.get(t,n)<s[n]&&(s[n]=this.get(t,n));return s}case void 0:{let s=this.get(0,0);for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.get(t,n)<s&&(s=this.get(t,n));return s}default:throw new Error(`invalid option: ${e}`)}}minIndex(){tt(this);let e=this.get(0,0),s=[0,0];for(let t=0;t<this.rows;t++)for(let n=0;n<this.columns;n++)this.get(t,n)<e&&(e=this.get(t,n),s[0]=t,s[1]=n);return s}maxRow(e){if(F(this,e),this.isEmpty())return NaN;let s=this.get(e,0);for(let t=1;t<this.columns;t++)this.get(e,t)>s&&(s=this.get(e,t));return s}maxRowIndex(e){F(this,e),tt(this);let s=this.get(e,0),t=[e,0];for(let n=1;n<this.columns;n++)this.get(e,n)>s&&(s=this.get(e,n),t[1]=n);return t}minRow(e){if(F(this,e),this.isEmpty())return NaN;let s=this.get(e,0);for(let t=1;t<this.columns;t++)this.get(e,t)<s&&(s=this.get(e,t));return s}minRowIndex(e){F(this,e),tt(this);let s=this.get(e,0),t=[e,0];for(let n=1;n<this.columns;n++)this.get(e,n)<s&&(s=this.get(e,n),t[1]=n);return t}maxColumn(e){if(T(this,e),this.isEmpty())return NaN;let s=this.get(0,e);for(let t=1;t<this.rows;t++)this.get(t,e)>s&&(s=this.get(t,e));return s}maxColumnIndex(e){T(this,e),tt(this);let s=this.get(0,e),t=[0,e];for(let n=1;n<this.rows;n++)this.get(n,e)>s&&(s=this.get(n,e),t[0]=n);return t}minColumn(e){if(T(this,e),this.isEmpty())return NaN;let s=this.get(0,e);for(let t=1;t<this.rows;t++)this.get(t,e)<s&&(s=this.get(t,e));return s}minColumnIndex(e){T(this,e),tt(this);let s=this.get(0,e),t=[0,e];for(let n=1;n<this.rows;n++)this.get(n,e)<s&&(s=this.get(n,e),t[0]=n);return t}diag(){let e=Math.min(this.rows,this.columns),s=[];for(let t=0;t<e;t++)s.push(this.get(t,t));return s}norm(e="frobenius"){switch(e){case"max":return this.max();case"frobenius":return Math.sqrt(this.dot(this));default:throw new RangeError(`unknown norm type: ${e}`)}}cumulativeSum(){let e=0;for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)e+=this.get(s,t),this.set(s,t,e);return this}dot(e){U.isMatrix(e)&&(e=e.to1DArray());let s=this.to1DArray();if(s.length!==e.length)throw new RangeError("vectors do not have the same size");let t=0;for(let n=0;n<s.length;n++)t+=s[n]*e[n];return t}mmul(e){e=P.checkMatrix(e);let s=this.rows,t=this.columns,n=e.columns,o=new P(s,n),i=new Float64Array(t);for(let l=0;l<n;l++){for(let u=0;u<t;u++)i[u]=e.get(u,l);for(let u=0;u<s;u++){let h=0;for(let d=0;d<t;d++)h+=this.get(u,d)*i[d];o.set(u,l,h)}}return o}mpow(e){if(!this.isSquare())throw new RangeError("Matrix must be square");if(!Number.isInteger(e)||e<0)throw new RangeError("Exponent must be a non-negative integer");let s=P.eye(this.rows),t=this;for(let n=e;n>=1;n/=2)(n&1)!==0&&(s=s.mmul(t)),t=t.mmul(t);return s}strassen2x2(e){e=P.checkMatrix(e);let s=new P(2,2);const t=this.get(0,0),n=e.get(0,0),o=this.get(0,1),i=e.get(0,1),l=this.get(1,0),u=e.get(1,0),h=this.get(1,1),d=e.get(1,1),g=(t+h)*(n+d),E=(l+h)*n,q=t*(i-d),M=h*(u-n),v=(t+o)*d,N=(l-t)*(n+i),m=(o-h)*(u+d),L=g+M-v+m,x=q+v,V=E+M,G=g-E+q+N;return s.set(0,0,L),s.set(0,1,x),s.set(1,0,V),s.set(1,1,G),s}strassen3x3(e){e=P.checkMatrix(e);let s=new P(3,3);const t=this.get(0,0),n=this.get(0,1),o=this.get(0,2),i=this.get(1,0),l=this.get(1,1),u=this.get(1,2),h=this.get(2,0),d=this.get(2,1),g=this.get(2,2),E=e.get(0,0),q=e.get(0,1),M=e.get(0,2),v=e.get(1,0),N=e.get(1,1),m=e.get(1,2),L=e.get(2,0),x=e.get(2,1),V=e.get(2,2),G=(t+n+o-i-l-d-g)*N,nt=(t-i)*(-q+N),O=l*(-E+q+v-N-m-L+V),B=(-t+i+l)*(E-q+N),et=(i+l)*(-E+q),w=t*E,I=(-t+h+d)*(E-M+m),D=(-t+h)*(M-m),C=(h+d)*(-E+M),ot=(t+n+o-l-u-h-d)*m,Z=d*(-E+M+v-N-m-L+x),st=(-o+d+g)*(N+L-x),rt=(o-g)*(N-x),ct=o*L,St=(d+g)*(-L+x),it=(-o+l+u)*(m+L-V),_t=(o-u)*(m-V),kt=(l+u)*(-L+V),Q=n*v,ft=u*x,dt=i*M,yt=h*q,lt=g*V,cs=w+ct+Q,fs=G+B+et+w+st+ct+St,as=w+I+C+ot+ct+it+kt,gs=nt+O+B+w+ct+it+_t,ms=nt+B+et+w+ft,ws=ct+it+_t+kt+dt,ps=w+I+D+Z+st+rt+ct,ds=st+rt+ct+St+yt,ys=w+I+D+C+lt;return s.set(0,0,cs),s.set(0,1,fs),s.set(0,2,as),s.set(1,0,gs),s.set(1,1,ms),s.set(1,2,ws),s.set(2,0,ps),s.set(2,1,ds),s.set(2,2,ys),s}mmulStrassen(e){e=P.checkMatrix(e);let s=this.clone(),t=s.rows,n=s.columns,o=e.rows,i=e.columns;n!==o&&console.warn(`Multiplying ${t} x ${n} and ${o} x ${i} matrix: dimensions do not match.`);function l(g,E,q){let M=g.rows,v=g.columns;if(M===E&&v===q)return g;{let N=U.zeros(E,q);return N=N.setSubMatrix(g,0,0),N}}let u=Math.max(t,o),h=Math.max(n,i);s=l(s,u,h),e=l(e,u,h);function d(g,E,q,M){if(q<=512||M<=512)return g.mmul(E);q%2===1&&M%2===1?(g=l(g,q+1,M+1),E=l(E,q+1,M+1)):q%2===1?(g=l(g,q+1,M),E=l(E,q+1,M)):M%2===1&&(g=l(g,q,M+1),E=l(E,q,M+1));let v=parseInt(g.rows/2,10),N=parseInt(g.columns/2,10),m=g.subMatrix(0,v-1,0,N-1),L=E.subMatrix(0,v-1,0,N-1),x=g.subMatrix(0,v-1,N,g.columns-1),V=E.subMatrix(0,v-1,N,E.columns-1),G=g.subMatrix(v,g.rows-1,0,N-1),nt=E.subMatrix(v,E.rows-1,0,N-1),O=g.subMatrix(v,g.rows-1,N,g.columns-1),B=E.subMatrix(v,E.rows-1,N,E.columns-1),et=d(U.add(m,O),U.add(L,B),v,N),w=d(U.add(G,O),L,v,N),I=d(m,U.sub(V,B),v,N),D=d(O,U.sub(nt,L),v,N),C=d(U.add(m,x),B,v,N),ot=d(U.sub(G,m),U.add(L,V),v,N),Z=d(U.sub(x,O),U.add(nt,B),v,N),st=U.add(et,D);st.sub(C),st.add(Z);let rt=U.add(I,C),ct=U.add(w,D),St=U.sub(et,w);St.add(I),St.add(ot);let it=U.zeros(2*st.rows,2*st.columns);return it=it.setSubMatrix(st,0,0),it=it.setSubMatrix(rt,st.rows,0),it=it.setSubMatrix(ct,0,st.columns),it=it.setSubMatrix(St,st.rows,st.columns),it.subMatrix(0,q-1,0,M-1)}return d(s,e,u,h)}scaleRows(e={}){if(typeof e!="object")throw new TypeError("options must be an object");const{min:s=0,max:t=1}=e;if(!Number.isFinite(s))throw new TypeError("min must be a number");if(!Number.isFinite(t))throw new TypeError("max must be a number");if(s>=t)throw new RangeError("min must be smaller than max");let n=new P(this.rows,this.columns);for(let o=0;o<this.rows;o++){const i=this.getRow(o);i.length>0&&c(i,{min:s,max:t,output:i}),n.setRow(o,i)}return n}scaleColumns(e={}){if(typeof e!="object")throw new TypeError("options must be an object");const{min:s=0,max:t=1}=e;if(!Number.isFinite(s))throw new TypeError("min must be a number");if(!Number.isFinite(t))throw new TypeError("max must be a number");if(s>=t)throw new RangeError("min must be smaller than max");let n=new P(this.rows,this.columns);for(let o=0;o<this.columns;o++){const i=this.getColumn(o);i.length&&c(i,{min:s,max:t,output:i}),n.setColumn(o,i)}return n}flipRows(){const e=Math.ceil(this.columns/2);for(let s=0;s<this.rows;s++)for(let t=0;t<e;t++){let n=this.get(s,t),o=this.get(s,this.columns-1-t);this.set(s,t,o),this.set(s,this.columns-1-t,n)}return this}flipColumns(){const e=Math.ceil(this.rows/2);for(let s=0;s<this.columns;s++)for(let t=0;t<e;t++){let n=this.get(t,s),o=this.get(this.rows-1-t,s);this.set(t,s,o),this.set(this.rows-1-t,s,n)}return this}kroneckerProduct(e){e=P.checkMatrix(e);let s=this.rows,t=this.columns,n=e.rows,o=e.columns,i=new P(s*n,t*o);for(let l=0;l<s;l++)for(let u=0;u<t;u++)for(let h=0;h<n;h++)for(let d=0;d<o;d++)i.set(n*l+h,o*u+d,this.get(l,u)*e.get(h,d));return i}kroneckerSum(e){if(e=P.checkMatrix(e),!this.isSquare()||!e.isSquare())throw new Error("Kronecker Sum needs two Square Matrices");let s=this.rows,t=e.rows,n=this.kroneckerProduct(P.eye(t,t)),o=P.eye(s,s).kroneckerProduct(e);return n.add(o)}transpose(){let e=new P(this.columns,this.rows);for(let s=0;s<this.rows;s++)for(let t=0;t<this.columns;t++)e.set(t,s,this.get(s,t));return e}sortRows(e=me){for(let s=0;s<this.rows;s++)this.setRow(s,this.getRow(s).sort(e));return this}sortColumns(e=me){for(let s=0;s<this.columns;s++)this.setColumn(s,this.getColumn(s).sort(e));return this}subMatrix(e,s,t,n){A(this,e,s,t,n);let o=new P(s-e+1,n-t+1);for(let i=e;i<=s;i++)for(let l=t;l<=n;l++)o.set(i-e,l-t,this.get(i,l));return o}subMatrixRow(e,s,t){if(s===void 0&&(s=0),t===void 0&&(t=this.columns-1),s>t||s<0||s>=this.columns||t<0||t>=this.columns)throw new RangeError("Argument out of range");let n=new P(e.length,t-s+1);for(let o=0;o<e.length;o++)for(let i=s;i<=t;i++){if(e[o]<0||e[o]>=this.rows)throw new RangeError(`Row index out of range: ${e[o]}`);n.set(o,i-s,this.get(e[o],i))}return n}subMatrixColumn(e,s,t){if(s===void 0&&(s=0),t===void 0&&(t=this.rows-1),s>t||s<0||s>=this.rows||t<0||t>=this.rows)throw new RangeError("Argument out of range");let n=new P(t-s+1,e.length);for(let o=0;o<e.length;o++)for(let i=s;i<=t;i++){if(e[o]<0||e[o]>=this.columns)throw new RangeError(`Column index out of range: ${e[o]}`);n.set(i-s,o,this.get(i,e[o]))}return n}setSubMatrix(e,s,t){if(e=P.checkMatrix(e),e.isEmpty())return this;let n=s+e.rows-1,o=t+e.columns-1;A(this,s,n,t,o);for(let i=0;i<e.rows;i++)for(let l=0;l<e.columns;l++)this.set(s+i,t+l,e.get(i,l));return this}selection(e,s){z(this,e),$(this,s);let t=new P(e.length,s.length);for(let n=0;n<e.length;n++){let o=e[n];for(let i=0;i<s.length;i++){let l=s[i];t.set(n,i,this.get(o,l))}}return t}trace(){let e=Math.min(this.rows,this.columns),s=0;for(let t=0;t<e;t++)s+=this.get(t,t);return s}clone(){return this.constructor.copy(this,new P(this.rows,this.columns))}static copy(e,s){for(const[t,n,o]of e.entries())s.set(t,n,o);return s}sum(e){switch(e){case"row":return ut(this);case"column":return K(this);case void 0:return ht(this);default:throw new Error(`invalid option: ${e}`)}}product(e){switch(e){case"row":return Ft(this);case"column":return gt(this);case void 0:return bt(this);default:throw new Error(`invalid option: ${e}`)}}mean(e){const s=this.sum(e);switch(e){case"row":{for(let t=0;t<this.rows;t++)s[t]/=this.columns;return s}case"column":{for(let t=0;t<this.columns;t++)s[t]/=this.rows;return s}case void 0:return s/this.size;default:throw new Error(`invalid option: ${e}`)}}variance(e,s={}){if(typeof e=="object"&&(s=e,e=void 0),typeof s!="object")throw new TypeError("options must be an object");const{unbiased:t=!0,mean:n=this.mean(e)}=s;if(typeof t!="boolean")throw new TypeError("unbiased must be a boolean");switch(e){case"row":{if(!f.isAnyArray(n))throw new TypeError("mean must be an array");return Mt(this,t,n)}case"column":{if(!f.isAnyArray(n))throw new TypeError("mean must be an array");return mt(this,t,n)}case void 0:{if(typeof n!="number")throw new TypeError("mean must be a number");return Tt(this,t,n)}default:throw new Error(`invalid option: ${e}`)}}standardDeviation(e,s){typeof e=="object"&&(s=e,e=void 0);const t=this.variance(e,s);if(e===void 0)return Math.sqrt(t);for(let n=0;n<t.length;n++)t[n]=Math.sqrt(t[n]);return t}center(e,s={}){if(typeof e=="object"&&(s=e,e=void 0),typeof s!="object")throw new TypeError("options must be an object");const{center:t=this.mean(e)}=s;switch(e){case"row":{if(!f.isAnyArray(t))throw new TypeError("center must be an array");return It(this,t),this}case"column":{if(!f.isAnyArray(t))throw new TypeError("center must be an array");return at(this,t),this}case void 0:{if(typeof t!="number")throw new TypeError("center must be a number");return wt(this,t),this}default:throw new Error(`invalid option: ${e}`)}}scale(e,s={}){if(typeof e=="object"&&(s=e,e=void 0),typeof s!="object")throw new TypeError("options must be an object");let t=s.scale;switch(e){case"row":{if(t===void 0)t=Et(this);else if(!f.isAnyArray(t))throw new TypeError("scale must be an array");return Rt(this,t),this}case"column":{if(t===void 0)t=Lt(this);else if(!f.isAnyArray(t))throw new TypeError("scale must be an array");return re(this,t),this}case void 0:{if(t===void 0)t=$e(this);else if(typeof t!="number")throw new TypeError("scale must be a number");return Be(this,t),this}default:throw new Error(`invalid option: ${e}`)}}toString(e){return _(this,e)}[Symbol.iterator](){return this.entries()}*entries(){for(let e=0;e<this.rows;e++)for(let s=0;s<this.columns;s++)yield[e,s,this.get(e,s)]}*values(){for(let e=0;e<this.rows;e++)for(let s=0;s<this.columns;s++)yield this.get(e,s)}}U.prototype.klass="Matrix",typeof Symbol<"u"&&(U.prototype[Symbol.for("nodejs.util.inspect.custom")]=y);function me(r,e){return r-e}function Ve(r){return r.every(e=>typeof e=="number")}U.random=U.rand,U.randomInt=U.randInt,U.diagonal=U.diag,U.prototype.diagonal=U.prototype.diag,U.identity=U.eye,U.prototype.negate=U.prototype.neg,U.prototype.tensorProduct=U.prototype.kroneckerProduct;class P extends U{data;#t(e,s){if(this.data=[],Number.isInteger(s)&&s>=0)for(let t=0;t<e;t++)this.data.push(new Float64Array(s));else throw new TypeError("nColumns must be a positive integer");this.rows=e,this.columns=s}constructor(e,s){if(super(),P.isMatrix(e))this.#t(e.rows,e.columns),P.copy(e,this);else if(Number.isInteger(e)&&e>=0)this.#t(e,s);else if(f.isAnyArray(e)){const t=e;if(e=t.length,s=e?t[0].length:0,typeof s!="number")throw new TypeError("Data must be a 2D array with at least one element");this.data=[];for(let n=0;n<e;n++){if(t[n].length!==s)throw new RangeError("Inconsistent array dimensions");if(!Ve(t[n]))throw new TypeError("Input data contains non-numeric values");this.data.push(Float64Array.from(t[n]))}this.rows=e,this.columns=s}else throw new TypeError("First argument must be a positive number or an array")}set(e,s,t){return this.data[e][s]=t,this}get(e,s){return this.data[e][s]}removeRow(e){return F(this,e),this.data.splice(e,1),this.rows-=1,this}addRow(e,s){return s===void 0&&(s=e,e=this.rows),F(this,e,!0),s=Float64Array.from(R(this,s)),this.data.splice(e,0,s),this.rows+=1,this}removeColumn(e){T(this,e);for(let s=0;s<this.rows;s++){const t=new Float64Array(this.columns-1);for(let n=0;n<e;n++)t[n]=this.data[s][n];for(let n=e+1;n<this.columns;n++)t[n-1]=this.data[s][n];this.data[s]=t}return this.columns-=1,this}addColumn(e,s){typeof s>"u"&&(s=e,e=this.columns),T(this,e,!0),s=W(this,s);for(let t=0;t<this.rows;t++){const n=new Float64Array(this.columns+1);let o=0;for(;o<e;o++)n[o]=this.data[t][o];for(n[o++]=s[t];o<this.columns+1;o++)n[o]=this.data[t][o-1];this.data[t]=n}return this.columns+=1,this}}j(U,P);class Ct extends U{#t;get size(){return this.#t.size}get rows(){return this.#t.rows}get columns(){return this.#t.columns}get diagonalSize(){return this.rows}static isSymmetricMatrix(e){return P.isMatrix(e)&&e.klassType==="SymmetricMatrix"}static zeros(e){return new this(e)}static ones(e){return new this(e).fill(1)}constructor(e){if(super(),P.isMatrix(e)){if(!e.isSymmetric())throw new TypeError("not symmetric data");this.#t=P.copy(e,new P(e.rows,e.rows))}else if(Number.isInteger(e)&&e>=0)this.#t=new P(e,e);else if(this.#t=new P(e),!this.isSymmetric())throw new TypeError("not symmetric data")}clone(){const e=new Ct(this.diagonalSize);for(const[s,t,n]of this.upperRightEntries())e.set(s,t,n);return e}toMatrix(){return new P(this)}get(e,s){return this.#t.get(e,s)}set(e,s,t){return this.#t.set(e,s,t),this.#t.set(s,e,t),this}removeCross(e){return this.#t.removeRow(e),this.#t.removeColumn(e),this}addCross(e,s){s===void 0&&(s=e,e=this.diagonalSize);const t=s.slice();return t.splice(e,1),this.#t.addRow(e,t),this.#t.addColumn(e,s),this}applyMask(e){if(e.length!==this.diagonalSize)throw new RangeError("Mask size do not match with matrix size");const s=[];for(const[t,n]of e.entries())n||s.push(t);s.reverse();for(const t of s)this.removeCross(t);return this}toCompact(){const{diagonalSize:e}=this,s=new Array(e*(e+1)/2);for(let t=0,n=0,o=0;o<s.length;o++)s[o]=this.get(n,t),++t>=e&&(t=++n);return s}static fromCompact(e){const s=e.length,t=(Math.sqrt(8*s+1)-1)/2;if(!Number.isInteger(t))throw new TypeError(`This array is not a compact representation of a Symmetric Matrix, ${JSON.stringify(e)}`);const n=new Ct(t);for(let o=0,i=0,l=0;l<s;l++)n.set(o,i,e[l]),++o>=t&&(o=++i);return n}*upperRightEntries(){for(let e=0,s=0;e<this.diagonalSize;void 0){const t=this.get(e,s);yield[e,s,t],++s>=this.diagonalSize&&(s=++e)}}*upperRightValues(){for(let e=0,s=0;e<this.diagonalSize;void 0)yield this.get(e,s),++s>=this.diagonalSize&&(s=++e)}}Ct.prototype.klassType="SymmetricMatrix";class At extends Ct{static isDistanceMatrix(e){return Ct.isSymmetricMatrix(e)&&e.klassSubType==="DistanceMatrix"}constructor(e){if(super(e),!this.isDistance())throw new TypeError("Provided arguments do no produce a distance matrix")}set(e,s,t){return e===s&&(t=0),super.set(e,s,t)}addCross(e,s){return s===void 0&&(s=e,e=this.diagonalSize),s=s.slice(),s[e]=0,super.addCross(e,s)}toSymmetricMatrix(){return new Ct(this)}clone(){const e=new At(this.diagonalSize);for(const[s,t,n]of this.upperRightEntries())s!==t&&e.set(s,t,n);return e}toCompact(){const{diagonalSize:e}=this,s=(e-1)*e/2,t=new Array(s);for(let n=1,o=0,i=0;i<t.length;i++)t[i]=this.get(o,n),++n>=e&&(n=++o+1);return t}static fromCompact(e){const s=e.length;if(s===0)return new this(0);const t=(Math.sqrt(8*s+1)+1)/2;if(!Number.isInteger(t))throw new TypeError(`This array is not a compact representation of a DistanceMatrix, ${JSON.stringify(e)}`);const n=new this(t);for(let o=1,i=0,l=0;l<s;l++)n.set(o,i,e[l]),++o>=t&&(o=++i+1);return n}}At.prototype.klassSubType="DistanceMatrix";class jt extends U{constructor(e,s,t){super(),this.matrix=e,this.rows=s,this.columns=t}}class Ge extends jt{constructor(e,s){T(e,s),super(e,e.rows,1),this.column=s}set(e,s,t){return this.matrix.set(e,this.column,t),this}get(e){return this.matrix.get(e,this.column)}}class Ue extends jt{constructor(e,s){$(e,s),super(e,e.rows,s.length),this.columnIndices=s}set(e,s,t){return this.matrix.set(e,this.columnIndices[s],t),this}get(e,s){return this.matrix.get(e,this.columnIndices[s])}}class Ae extends jt{constructor(e){super(e,e.rows,e.columns)}set(e,s,t){return this.matrix.set(e,this.columns-s-1,t),this}get(e,s){return this.matrix.get(e,this.columns-s-1)}}class Ye extends jt{constructor(e){super(e,e.rows,e.columns)}set(e,s,t){return this.matrix.set(this.rows-e-1,s,t),this}get(e,s){return this.matrix.get(this.rows-e-1,s)}}class Ke extends jt{constructor(e,s){F(e,s),super(e,1,e.columns),this.row=s}set(e,s,t){return this.matrix.set(this.row,s,t),this}get(e,s){return this.matrix.get(this.row,s)}}class Qe extends jt{constructor(e,s){z(e,s),super(e,s.length,e.columns),this.rowIndices=s}set(e,s,t){return this.matrix.set(this.rowIndices[e],s,t),this}get(e,s){return this.matrix.get(this.rowIndices[e],s)}}class Yt extends jt{constructor(e,s,t){z(e,s),$(e,t),super(e,s.length,t.length),this.rowIndices=s,this.columnIndices=t}set(e,s,t){return this.matrix.set(this.rowIndices[e],this.columnIndices[s],t),this}get(e,s){return this.matrix.get(this.rowIndices[e],this.columnIndices[s])}}class Je extends jt{constructor(e,s,t,n,o){A(e,s,t,n,o),super(e,t-s+1,o-n+1),this.startRow=s,this.startColumn=n}set(e,s,t){return this.matrix.set(this.startRow+e,this.startColumn+s,t),this}get(e,s){return this.matrix.get(this.startRow+e,this.startColumn+s)}}class Xe extends jt{constructor(e){super(e,e.columns,e.rows)}set(e,s,t){return this.matrix.set(s,e,t),this}get(e,s){return this.matrix.get(s,e)}}class we extends U{constructor(e,s={}){const{rows:t=1}=s;if(e.length%t!==0)throw new Error("the data length is not divisible by the number of rows");super(),this.rows=t,this.columns=e.length/t,this.data=e}set(e,s,t){let n=this._calculateIndex(e,s);return this.data[n]=t,this}get(e,s){let t=this._calculateIndex(e,s);return this.data[t]}_calculateIndex(e,s){return e*this.columns+s}}class pt extends U{constructor(e){super(),this.data=e,this.rows=e.length,this.columns=e[0].length}set(e,s,t){return this.data[e][s]=t,this}get(e,s){return this.data[e][s]}}function Ze(r,e){if(f.isAnyArray(r))return r[0]&&f.isAnyArray(r[0])?new pt(r):new we(r,e);throw new Error("the argument is not an array")}class Kt{constructor(e){e=pt.checkMatrix(e);let s=e.clone(),t=s.rows,n=s.columns,o=new Float64Array(t),i=1,l,u,h,d,g,E,q,M,v;for(l=0;l<t;l++)o[l]=l;for(M=new Float64Array(t),u=0;u<n;u++){for(l=0;l<t;l++)M[l]=s.get(l,u);for(l=0;l<t;l++){for(v=Math.min(l,u),g=0,h=0;h<v;h++)g+=s.get(l,h)*M[h];M[l]-=g,s.set(l,u,M[l])}for(d=u,l=u+1;l<t;l++)Math.abs(M[l])>Math.abs(M[d])&&(d=l);if(d!==u){for(h=0;h<n;h++)E=s.get(d,h),s.set(d,h,s.get(u,h)),s.set(u,h,E);q=o[d],o[d]=o[u],o[u]=q,i=-i}if(u<t&&s.get(u,u)!==0)for(l=u+1;l<t;l++)s.set(l,u,s.get(l,u)/s.get(u,u))}this.LU=s,this.pivotVector=o,this.pivotSign=i}isSingular(){let e=this.LU,s=e.columns;for(let t=0;t<s;t++)if(e.get(t,t)===0)return!0;return!1}solve(e){e=P.checkMatrix(e);let s=this.LU;if(s.rows!==e.rows)throw new Error("Invalid matrix dimensions");if(this.isSingular())throw new Error("LU matrix is singular");let n=e.columns,o=e.subMatrixRow(this.pivotVector,0,n-1),i=s.columns,l,u,h;for(h=0;h<i;h++)for(l=h+1;l<i;l++)for(u=0;u<n;u++)o.set(l,u,o.get(l,u)-o.get(h,u)*s.get(l,h));for(h=i-1;h>=0;h--){for(u=0;u<n;u++)o.set(h,u,o.get(h,u)/s.get(h,h));for(l=0;l<h;l++)for(u=0;u<n;u++)o.set(l,u,o.get(l,u)-o.get(h,u)*s.get(l,h))}return o}get determinant(){let e=this.LU;if(!e.isSquare())throw new Error("Matrix must be square");let s=this.pivotSign,t=e.columns;for(let n=0;n<t;n++)s*=e.get(n,n);return s}get lowerTriangularMatrix(){let e=this.LU,s=e.rows,t=e.columns,n=new P(s,t);for(let o=0;o<s;o++)for(let i=0;i<t;i++)o>i?n.set(o,i,e.get(o,i)):o===i?n.set(o,i,1):n.set(o,i,0);return n}get upperTriangularMatrix(){let e=this.LU,s=e.rows,t=e.columns,n=new P(s,t);for(let o=0;o<s;o++)for(let i=0;i<t;i++)o<=i?n.set(o,i,e.get(o,i)):n.set(o,i,0);return n}get pivotPermutationVector(){return Array.from(this.pivotVector)}}function vt(r,e){let s=0;return Math.abs(r)>Math.abs(e)?(s=e/r,Math.abs(r)*Math.sqrt(1+s*s)):e!==0?(s=r/e,Math.abs(e)*Math.sqrt(1+s*s)):0}class ie{constructor(e){e=pt.checkMatrix(e);let s=e.clone(),t=e.rows,n=e.columns,o=new Float64Array(n),i,l,u,h;for(u=0;u<n;u++){let d=0;for(i=u;i<t;i++)d=vt(d,s.get(i,u));if(d!==0){for(s.get(u,u)<0&&(d=-d),i=u;i<t;i++)s.set(i,u,s.get(i,u)/d);for(s.set(u,u,s.get(u,u)+1),l=u+1;l<n;l++){for(h=0,i=u;i<t;i++)h+=s.get(i,u)*s.get(i,l);for(h=-h/s.get(u,u),i=u;i<t;i++)s.set(i,l,s.get(i,l)+h*s.get(i,u))}}o[u]=-d}this.QR=s,this.Rdiag=o}solve(e){e=P.checkMatrix(e);let s=this.QR,t=s.rows;if(e.rows!==t)throw new Error("Matrix row dimensions must agree");if(!this.isFullRank())throw new Error("Matrix is rank deficient");let n=e.columns,o=e.clone(),i=s.columns,l,u,h,d;for(h=0;h<i;h++)for(u=0;u<n;u++){for(d=0,l=h;l<t;l++)d+=s.get(l,h)*o.get(l,u);for(d=-d/s.get(h,h),l=h;l<t;l++)o.set(l,u,o.get(l,u)+d*s.get(l,h))}for(h=i-1;h>=0;h--){for(u=0;u<n;u++)o.set(h,u,o.get(h,u)/this.Rdiag[h]);for(l=0;l<h;l++)for(u=0;u<n;u++)o.set(l,u,o.get(l,u)-o.get(h,u)*s.get(l,h))}return o.subMatrix(0,i-1,0,n-1)}isFullRank(){let e=this.QR.columns;for(let s=0;s<e;s++)if(this.Rdiag[s]===0)return!1;return!0}get upperTriangularMatrix(){let e=this.QR,s=e.columns,t=new P(s,s),n,o;for(n=0;n<s;n++)for(o=0;o<s;o++)n<o?t.set(n,o,e.get(n,o)):n===o?t.set(n,o,this.Rdiag[n]):t.set(n,o,0);return t}get orthogonalMatrix(){let e=this.QR,s=e.rows,t=e.columns,n=new P(s,t),o,i,l,u;for(l=t-1;l>=0;l--){for(o=0;o<s;o++)n.set(o,l,0);for(n.set(l,l,1),i=l;i<t;i++)if(e.get(l,l)!==0){for(u=0,o=l;o<s;o++)u+=e.get(o,l)*n.get(o,i);for(u=-u/e.get(l,l),o=l;o<s;o++)n.set(o,i,n.get(o,i)+u*e.get(o,l))}}return n}}class qt{constructor(e,s={}){if(e=pt.checkMatrix(e),e.isEmpty())throw new Error("Matrix must be non-empty");let t=e.rows,n=e.columns;const{computeLeftSingularVectors:o=!0,computeRightSingularVectors:i=!0,autoTranspose:l=!1}=s;let u=!!o,h=!!i,d=!1,g;if(t<n)if(!l)g=e.clone(),console.warn("Computing SVD on a matrix with more columns than rows. Consider enabling autoTranspose");else{g=e.transpose(),t=g.rows,n=g.columns,d=!0;let w=u;u=h,h=w}else g=e.clone();let E=Math.min(t,n),q=Math.min(t+1,n),M=new Float64Array(q),v=new P(t,E),N=new P(n,n),m=new Float64Array(n),L=new Float64Array(t),x=new Float64Array(q);for(let w=0;w<q;w++)x[w]=w;let V=Math.min(t-1,n),G=Math.max(0,Math.min(n-2,t)),nt=Math.max(V,G);for(let w=0;w<nt;w++){if(w<V){M[w]=0;for(let I=w;I<t;I++)M[w]=vt(M[w],g.get(I,w));if(M[w]!==0){g.get(w,w)<0&&(M[w]=-M[w]);for(let I=w;I<t;I++)g.set(I,w,g.get(I,w)/M[w]);g.set(w,w,g.get(w,w)+1)}M[w]=-M[w]}for(let I=w+1;I<n;I++){if(w<V&&M[w]!==0){let D=0;for(let C=w;C<t;C++)D+=g.get(C,w)*g.get(C,I);D=-D/g.get(w,w);for(let C=w;C<t;C++)g.set(C,I,g.get(C,I)+D*g.get(C,w))}m[I]=g.get(w,I)}if(u&&w<V)for(let I=w;I<t;I++)v.set(I,w,g.get(I,w));if(w<G){m[w]=0;for(let I=w+1;I<n;I++)m[w]=vt(m[w],m[I]);if(m[w]!==0){m[w+1]<0&&(m[w]=0-m[w]);for(let I=w+1;I<n;I++)m[I]/=m[w];m[w+1]+=1}if(m[w]=-m[w],w+1<t&&m[w]!==0){for(let I=w+1;I<t;I++)L[I]=0;for(let I=w+1;I<t;I++)for(let D=w+1;D<n;D++)L[I]+=m[D]*g.get(I,D);for(let I=w+1;I<n;I++){let D=-m[I]/m[w+1];for(let C=w+1;C<t;C++)g.set(C,I,g.get(C,I)+D*L[C])}}if(h)for(let I=w+1;I<n;I++)N.set(I,w,m[I])}}let O=Math.min(n,t+1);if(V<n&&(M[V]=g.get(V,V)),t<O&&(M[O-1]=0),G+1<O&&(m[G]=g.get(G,O-1)),m[O-1]=0,u){for(let w=V;w<E;w++){for(let I=0;I<t;I++)v.set(I,w,0);v.set(w,w,1)}for(let w=V-1;w>=0;w--)if(M[w]!==0){for(let I=w+1;I<E;I++){let D=0;for(let C=w;C<t;C++)D+=v.get(C,w)*v.get(C,I);D=-D/v.get(w,w);for(let C=w;C<t;C++)v.set(C,I,v.get(C,I)+D*v.get(C,w))}for(let I=w;I<t;I++)v.set(I,w,-v.get(I,w));v.set(w,w,1+v.get(w,w));for(let I=0;I<w-1;I++)v.set(I,w,0)}else{for(let I=0;I<t;I++)v.set(I,w,0);v.set(w,w,1)}}if(h)for(let w=n-1;w>=0;w--){if(w<G&&m[w]!==0)for(let I=w+1;I<n;I++){let D=0;for(let C=w+1;C<n;C++)D+=N.get(C,w)*N.get(C,I);D=-D/N.get(w+1,w);for(let C=w+1;C<n;C++)N.set(C,I,N.get(C,I)+D*N.get(C,w))}for(let I=0;I<n;I++)N.set(I,w,0);N.set(w,w,1)}let B=O-1,et=Number.EPSILON;for(;O>0;){let w,I;for(w=O-2;w>=-1&&w!==-1;w--){const D=Number.MIN_VALUE+et*Math.abs(M[w]+Math.abs(M[w+1]));if(Math.abs(m[w])<=D||Number.isNaN(m[w])){m[w]=0;break}}if(w===O-2)I=4;else{let D;for(D=O-1;D>=w&&D!==w;D--){let C=(D!==O?Math.abs(m[D]):0)+(D!==w+1?Math.abs(m[D-1]):0);if(Math.abs(M[D])<=et*C){M[D]=0;break}}D===w?I=3:D===O-1?I=1:(I=2,w=D)}switch(w++,I){case 1:{let D=m[O-2];m[O-2]=0;for(let C=O-2;C>=w;C--){let ot=vt(M[C],D),Z=M[C]/ot,st=D/ot;if(M[C]=ot,C!==w&&(D=-st*m[C-1],m[C-1]=Z*m[C-1]),h)for(let rt=0;rt<n;rt++)ot=Z*N.get(rt,C)+st*N.get(rt,O-1),N.set(rt,O-1,-st*N.get(rt,C)+Z*N.get(rt,O-1)),N.set(rt,C,ot)}break}case 2:{let D=m[w-1];m[w-1]=0;for(let C=w;C<O;C++){let ot=vt(M[C],D),Z=M[C]/ot,st=D/ot;if(M[C]=ot,D=-st*m[C],m[C]=Z*m[C],u)for(let rt=0;rt<t;rt++)ot=Z*v.get(rt,C)+st*v.get(rt,w-1),v.set(rt,w-1,-st*v.get(rt,C)+Z*v.get(rt,w-1)),v.set(rt,C,ot)}break}case 3:{const D=Math.max(Math.abs(M[O-1]),Math.abs(M[O-2]),Math.abs(m[O-2]),Math.abs(M[w]),Math.abs(m[w])),C=M[O-1]/D,ot=M[O-2]/D,Z=m[O-2]/D,st=M[w]/D,rt=m[w]/D,ct=((ot+C)*(ot-C)+Z*Z)/2,St=C*Z*(C*Z);let it=0;(ct!==0||St!==0)&&(ct<0?it=0-Math.sqrt(ct*ct+St):it=Math.sqrt(ct*ct+St),it=St/(ct+it));let _t=(st+C)*(st-C)+it,kt=st*rt;for(let Q=w;Q<O-1;Q++){let ft=vt(_t,kt);ft===0&&(ft=Number.MIN_VALUE);let dt=_t/ft,yt=kt/ft;if(Q!==w&&(m[Q-1]=ft),_t=dt*M[Q]+yt*m[Q],m[Q]=dt*m[Q]-yt*M[Q],kt=yt*M[Q+1],M[Q+1]=dt*M[Q+1],h)for(let lt=0;lt<n;lt++)ft=dt*N.get(lt,Q)+yt*N.get(lt,Q+1),N.set(lt,Q+1,-yt*N.get(lt,Q)+dt*N.get(lt,Q+1)),N.set(lt,Q,ft);if(ft=vt(_t,kt),ft===0&&(ft=Number.MIN_VALUE),dt=_t/ft,yt=kt/ft,M[Q]=ft,_t=dt*m[Q]+yt*M[Q+1],M[Q+1]=-yt*m[Q]+dt*M[Q+1],kt=yt*m[Q+1],m[Q+1]=dt*m[Q+1],u&&Q<t-1)for(let lt=0;lt<t;lt++)ft=dt*v.get(lt,Q)+yt*v.get(lt,Q+1),v.set(lt,Q+1,-yt*v.get(lt,Q)+dt*v.get(lt,Q+1)),v.set(lt,Q,ft)}m[O-2]=_t;break}case 4:{if(M[w]<=0&&(M[w]=M[w]<0?-M[w]:0,h))for(let D=0;D<=B;D++)N.set(D,w,-N.get(D,w));for(;w<B&&!(M[w]>=M[w+1]);){let D=M[w];if(M[w]=M[w+1],M[w+1]=D,h&&w<n-1)for(let C=0;C<n;C++)D=N.get(C,w+1),N.set(C,w+1,N.get(C,w)),N.set(C,w,D);if(u&&w<t-1)for(let C=0;C<t;C++)D=v.get(C,w+1),v.set(C,w+1,v.get(C,w)),v.set(C,w,D);w++}O--;break}}}if(d){let w=N;N=v,v=w}this.m=t,this.n=n,this.s=M,this.U=v,this.V=N}solve(e){let s=e,t=this.threshold,n=this.s.length,o=P.zeros(n,n);for(let E=0;E<n;E++)Math.abs(this.s[E])<=t?o.set(E,E,0):o.set(E,E,1/this.s[E]);let i=this.U,l=this.rightSingularVectors,u=l.mmul(o),h=l.rows,d=i.rows,g=P.zeros(h,d);for(let E=0;E<h;E++)for(let q=0;q<d;q++){let M=0;for(let v=0;v<n;v++)M+=u.get(E,v)*i.get(q,v);g.set(E,q,M)}return g.mmul(s)}solveForDiagonal(e){return this.solve(P.diag(e))}inverse(){let e=this.V,s=this.threshold,t=e.rows,n=e.columns,o=new P(t,this.s.length);for(let d=0;d<t;d++)for(let g=0;g<n;g++)Math.abs(this.s[g])>s&&o.set(d,g,e.get(d,g)/this.s[g]);let i=this.U,l=i.rows,u=i.columns,h=new P(t,l);for(let d=0;d<t;d++)for(let g=0;g<l;g++){let E=0;for(let q=0;q<u;q++)E+=o.get(d,q)*i.get(g,q);h.set(d,g,E)}return h}get condition(){return this.s[0]/this.s[Math.min(this.m,this.n)-1]}get norm2(){return this.s[0]}get rank(){let e=Math.max(this.m,this.n)*this.s[0]*Number.EPSILON,s=0,t=this.s;for(let n=0,o=t.length;n<o;n++)t[n]>e&&s++;return s}get diagonal(){return Array.from(this.s)}get threshold(){return Number.EPSILON/2*Math.max(this.m,this.n)*this.s[0]}get leftSingularVectors(){return this.U}get rightSingularVectors(){return this.V}get diagonalMatrix(){return P.diag(this.s)}}function He(r,e=!1){return r=pt.checkMatrix(r),e?new qt(r).inverse():pe(r,P.eye(r.rows))}function pe(r,e,s=!1){return r=pt.checkMatrix(r),e=pt.checkMatrix(e),s?new qt(r).solve(e):r.isSquare()?new Kt(r).solve(e):new ie(r).solve(e)}function Qt(r){if(r=P.checkMatrix(r),r.isSquare()){if(r.columns===0)return 1;let e,s,t,n;if(r.columns===2)return e=r.get(0,0),s=r.get(0,1),t=r.get(1,0),n=r.get(1,1),e*n-s*t;if(r.columns===3){let o,i,l;return o=new Yt(r,[1,2],[1,2]),i=new Yt(r,[1,2],[0,2]),l=new Yt(r,[1,2],[0,1]),e=r.get(0,0),s=r.get(0,1),t=r.get(0,2),e*Qt(o)-s*Qt(i)+t*Qt(l)}else return new Kt(r).determinant}else throw Error("determinant can only be calculated for a square matrix")}function ts(r,e){let s=[];for(let t=0;t<r;t++)t!==e&&s.push(t);return s}function es(r,e,s,t=1e-9,n=1e-9){if(r>n)return new Array(e.rows+1).fill(0);{let o=e.addRow(s,[0]);for(let i=0;i<o.rows;i++)Math.abs(o.get(i,0))<t&&o.set(i,0,0);return o.to1DArray()}}function ss(r,e={}){const{thresholdValue:s=1e-9,thresholdError:t=1e-9}=e;r=P.checkMatrix(r);let n=r.rows,o=new P(n,n);for(let i=0;i<n;i++){let l=P.columnVector(r.getRow(i)),u=r.subMatrixRow(ts(n,i)).transpose(),d=new qt(u).solve(l),g=P.sub(l,u.mmul(d)).abs().max();o.setRow(i,es(g,d,i,s,t))}return o}function ns(r,e=Number.EPSILON){if(r=P.checkMatrix(r),r.isEmpty())return r.transpose();let s=new qt(r,{autoTranspose:!0}),t=s.leftSingularVectors,n=s.rightSingularVectors,o=s.diagonal;for(let i=0;i<o.length;i++)Math.abs(o[i])>e?o[i]=1/o[i]:o[i]=0;return n.mmul(P.diag(o).mmul(t.transpose()))}function os(r,e=r,s={}){r=new P(r);let t=!1;if(typeof e=="object"&&!P.isMatrix(e)&&!f.isAnyArray(e)?(s=e,e=r,t=!0):e=new P(e),r.rows!==e.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:n=!0}=s;n&&(r=r.center("column"),t||(e=e.center("column")));const o=r.transpose().mmul(e);for(let i=0;i<o.rows;i++)for(let l=0;l<o.columns;l++)o.set(i,l,o.get(i,l)*(1/(r.rows-1)));return o}function rs(r,e=r,s={}){r=new P(r);let t=!1;if(typeof e=="object"&&!P.isMatrix(e)&&!f.isAnyArray(e)?(s=e,e=r,t=!0):e=new P(e),r.rows!==e.rows)throw new TypeError("Both matrices must have the same number of rows");const{center:n=!0,scale:o=!0}=s;n&&(r.center("column"),t||e.center("column")),o&&(r.scale("column"),t||e.scale("column"));const i=r.standardDeviation("column",{unbiased:!0}),l=t?i:e.standardDeviation("column",{unbiased:!0}),u=r.transpose().mmul(e);for(let h=0;h<u.rows;h++)for(let d=0;d<u.columns;d++)u.set(h,d,u.get(h,d)*(1/(i[h]*l[d]))*(1/(r.rows-1)));return u}class de{constructor(e,s={}){const{assumeSymmetric:t=!1}=s;if(e=pt.checkMatrix(e),!e.isSquare())throw new Error("Matrix is not a square matrix");if(e.isEmpty())throw new Error("Matrix must be non-empty");let n=e.columns,o=new P(n,n),i=new Float64Array(n),l=new Float64Array(n),u=e,h,d,g=!1;if(t?g=!0:g=e.isSymmetric(),g){for(h=0;h<n;h++)for(d=0;d<n;d++)o.set(h,d,u.get(h,d));is(n,l,i,o),ls(n,l,i,o)}else{let E=new P(n,n),q=new Float64Array(n);for(d=0;d<n;d++)for(h=0;h<n;h++)E.set(h,d,u.get(h,d));us(n,E,q,o),hs(n,l,i,o,E)}this.n=n,this.e=l,this.d=i,this.V=o}get realEigenvalues(){return Array.from(this.d)}get imaginaryEigenvalues(){return Array.from(this.e)}get eigenvectorMatrix(){return this.V}get diagonalMatrix(){let e=this.n,s=this.e,t=this.d,n=new P(e,e),o,i;for(o=0;o<e;o++){for(i=0;i<e;i++)n.set(o,i,0);n.set(o,o,t[o]),s[o]>0?n.set(o,o+1,s[o]):s[o]<0&&n.set(o,o-1,s[o])}return n}}function is(r,e,s,t){let n,o,i,l,u,h,d,g;for(u=0;u<r;u++)s[u]=t.get(r-1,u);for(l=r-1;l>0;l--){for(g=0,i=0,h=0;h<l;h++)g=g+Math.abs(s[h]);if(g===0)for(e[l]=s[l-1],u=0;u<l;u++)s[u]=t.get(l-1,u),t.set(l,u,0),t.set(u,l,0);else{for(h=0;h<l;h++)s[h]/=g,i+=s[h]*s[h];for(n=s[l-1],o=Math.sqrt(i),n>0&&(o=-o),e[l]=g*o,i=i-n*o,s[l-1]=n-o,u=0;u<l;u++)e[u]=0;for(u=0;u<l;u++){for(n=s[u],t.set(u,l,n),o=e[u]+t.get(u,u)*n,h=u+1;h<=l-1;h++)o+=t.get(h,u)*s[h],e[h]+=t.get(h,u)*n;e[u]=o}for(n=0,u=0;u<l;u++)e[u]/=i,n+=e[u]*s[u];for(d=n/(i+i),u=0;u<l;u++)e[u]-=d*s[u];for(u=0;u<l;u++){for(n=s[u],o=e[u],h=u;h<=l-1;h++)t.set(h,u,t.get(h,u)-(n*e[h]+o*s[h]));s[u]=t.get(l-1,u),t.set(l,u,0)}}s[l]=i}for(l=0;l<r-1;l++){if(t.set(r-1,l,t.get(l,l)),t.set(l,l,1),i=s[l+1],i!==0){for(h=0;h<=l;h++)s[h]=t.get(h,l+1)/i;for(u=0;u<=l;u++){for(o=0,h=0;h<=l;h++)o+=t.get(h,l+1)*t.get(h,u);for(h=0;h<=l;h++)t.set(h,u,t.get(h,u)-o*s[h])}}for(h=0;h<=l;h++)t.set(h,l+1,0)}for(u=0;u<r;u++)s[u]=t.get(r-1,u),t.set(r-1,u,0);t.set(r-1,r-1,1),e[0]=0}function ls(r,e,s,t){let n,o,i,l,u,h,d,g,E,q,M,v,N,m,L,x;for(i=1;i<r;i++)e[i-1]=e[i];e[r-1]=0;let V=0,G=0,nt=Number.EPSILON;for(h=0;h<r;h++){for(G=Math.max(G,Math.abs(s[h])+Math.abs(e[h])),d=h;d<r&&!(Math.abs(e[d])<=nt*G);)d++;if(d>h)do{for(n=s[h],g=(s[h+1]-n)/(2*e[h]),E=vt(g,1),g<0&&(E=-E),s[h]=e[h]/(g+E),s[h+1]=e[h]*(g+E),q=s[h+1],o=n-s[h],i=h+2;i<r;i++)s[i]-=o;for(V=V+o,g=s[d],M=1,v=M,N=M,m=e[h+1],L=0,x=0,i=d-1;i>=h;i--)for(N=v,v=M,x=L,n=M*e[i],o=M*g,E=vt(g,e[i]),e[i+1]=L*E,L=e[i]/E,M=g/E,g=M*s[i]-L*n,s[i+1]=o+L*(M*n+L*s[i]),u=0;u<r;u++)o=t.get(u,i+1),t.set(u,i+1,L*t.get(u,i)+M*o),t.set(u,i,M*t.get(u,i)-L*o);g=-L*x*N*m*e[h]/q,e[h]=L*g,s[h]=M*g}while(Math.abs(e[h])>nt*G);s[h]=s[h]+V,e[h]=0}for(i=0;i<r-1;i++){for(u=i,g=s[i],l=i+1;l<r;l++)s[l]<g&&(u=l,g=s[l]);if(u!==i)for(s[u]=s[i],s[i]=g,l=0;l<r;l++)g=t.get(l,i),t.set(l,i,t.get(l,u)),t.set(l,u,g)}}function us(r,e,s,t){let n=0,o=r-1,i,l,u,h,d,g,E;for(g=n+1;g<=o-1;g++){for(E=0,h=g;h<=o;h++)E=E+Math.abs(e.get(h,g-1));if(E!==0){for(u=0,h=o;h>=g;h--)s[h]=e.get(h,g-1)/E,u+=s[h]*s[h];for(l=Math.sqrt(u),s[g]>0&&(l=-l),u=u-s[g]*l,s[g]=s[g]-l,d=g;d<r;d++){for(i=0,h=o;h>=g;h--)i+=s[h]*e.get(h,d);for(i=i/u,h=g;h<=o;h++)e.set(h,d,e.get(h,d)-i*s[h])}for(h=0;h<=o;h++){for(i=0,d=o;d>=g;d--)i+=s[d]*e.get(h,d);for(i=i/u,d=g;d<=o;d++)e.set(h,d,e.get(h,d)-i*s[d])}s[g]=E*s[g],e.set(g,g-1,E*l)}}for(h=0;h<r;h++)for(d=0;d<r;d++)t.set(h,d,h===d?1:0);for(g=o-1;g>=n+1;g--)if(e.get(g,g-1)!==0){for(h=g+1;h<=o;h++)s[h]=e.get(h,g-1);for(d=g;d<=o;d++){for(l=0,h=g;h<=o;h++)l+=s[h]*t.get(h,d);for(l=l/s[g]/e.get(g,g-1),h=g;h<=o;h++)t.set(h,d,t.get(h,d)+l*s[h])}}}function hs(r,e,s,t,n){let o=r-1,i=0,l=r-1,u=Number.EPSILON,h=0,d=0,g=0,E=0,q=0,M=0,v=0,N=0,m,L,x,V,G,nt,O,B,et,w,I,D,C,ot,Z;for(m=0;m<r;m++)for((m<i||m>l)&&(s[m]=n.get(m,m),e[m]=0),L=Math.max(m-1,0);L<r;L++)d=d+Math.abs(n.get(m,L));for(;o>=i;){for(V=o;V>i&&(M=Math.abs(n.get(V-1,V-1))+Math.abs(n.get(V,V)),M===0&&(M=d),!(Math.abs(n.get(V,V-1))<u*M));)V--;if(V===o)n.set(o,o,n.get(o,o)+h),s[o]=n.get(o,o),e[o]=0,o--,N=0;else if(V===o-1){if(O=n.get(o,o-1)*n.get(o-1,o),g=(n.get(o-1,o-1)-n.get(o,o))/2,E=g*g+O,v=Math.sqrt(Math.abs(E)),n.set(o,o,n.get(o,o)+h),n.set(o-1,o-1,n.get(o-1,o-1)+h),B=n.get(o,o),E>=0){for(v=g>=0?g+v:g-v,s[o-1]=B+v,s[o]=s[o-1],v!==0&&(s[o]=B-O/v),e[o-1]=0,e[o]=0,B=n.get(o,o-1),M=Math.abs(B)+Math.abs(v),g=B/M,E=v/M,q=Math.sqrt(g*g+E*E),g=g/q,E=E/q,L=o-1;L<r;L++)v=n.get(o-1,L),n.set(o-1,L,E*v+g*n.get(o,L)),n.set(o,L,E*n.get(o,L)-g*v);for(m=0;m<=o;m++)v=n.get(m,o-1),n.set(m,o-1,E*v+g*n.get(m,o)),n.set(m,o,E*n.get(m,o)-g*v);for(m=i;m<=l;m++)v=t.get(m,o-1),t.set(m,o-1,E*v+g*t.get(m,o)),t.set(m,o,E*t.get(m,o)-g*v)}else s[o-1]=B+g,s[o]=B+g,e[o-1]=v,e[o]=-v;o=o-2,N=0}else{if(B=n.get(o,o),et=0,O=0,V<o&&(et=n.get(o-1,o-1),O=n.get(o,o-1)*n.get(o-1,o)),N===10){for(h+=B,m=i;m<=o;m++)n.set(m,m,n.get(m,m)-B);M=Math.abs(n.get(o,o-1))+Math.abs(n.get(o-1,o-2)),B=et=.75*M,O=-.4375*M*M}if(N===30&&(M=(et-B)/2,M=M*M+O,M>0)){for(M=Math.sqrt(M),et<B&&(M=-M),M=B-O/((et-B)/2+M),m=i;m<=o;m++)n.set(m,m,n.get(m,m)-M);h+=M,B=et=O=.964}for(N=N+1,G=o-2;G>=V&&(v=n.get(G,G),q=B-v,M=et-v,g=(q*M-O)/n.get(G+1,G)+n.get(G,G+1),E=n.get(G+1,G+1)-v-q-M,q=n.get(G+2,G+1),M=Math.abs(g)+Math.abs(E)+Math.abs(q),g=g/M,E=E/M,q=q/M,!(G===V||Math.abs(n.get(G,G-1))*(Math.abs(E)+Math.abs(q))<u*(Math.abs(g)*(Math.abs(n.get(G-1,G-1))+Math.abs(v)+Math.abs(n.get(G+1,G+1))))));)G--;for(m=G+2;m<=o;m++)n.set(m,m-2,0),m>G+2&&n.set(m,m-3,0);for(x=G;x<=o-1&&(ot=x!==o-1,x!==G&&(g=n.get(x,x-1),E=n.get(x+1,x-1),q=ot?n.get(x+2,x-1):0,B=Math.abs(g)+Math.abs(E)+Math.abs(q),B!==0&&(g=g/B,E=E/B,q=q/B)),B!==0);x++)if(M=Math.sqrt(g*g+E*E+q*q),g<0&&(M=-M),M!==0){for(x!==G?n.set(x,x-1,-M*B):V!==G&&n.set(x,x-1,-n.get(x,x-1)),g=g+M,B=g/M,et=E/M,v=q/M,E=E/g,q=q/g,L=x;L<r;L++)g=n.get(x,L)+E*n.get(x+1,L),ot&&(g=g+q*n.get(x+2,L),n.set(x+2,L,n.get(x+2,L)-g*v)),n.set(x,L,n.get(x,L)-g*B),n.set(x+1,L,n.get(x+1,L)-g*et);for(m=0;m<=Math.min(o,x+3);m++)g=B*n.get(m,x)+et*n.get(m,x+1),ot&&(g=g+v*n.get(m,x+2),n.set(m,x+2,n.get(m,x+2)-g*q)),n.set(m,x,n.get(m,x)-g),n.set(m,x+1,n.get(m,x+1)-g*E);for(m=i;m<=l;m++)g=B*t.get(m,x)+et*t.get(m,x+1),ot&&(g=g+v*t.get(m,x+2),t.set(m,x+2,t.get(m,x+2)-g*q)),t.set(m,x,t.get(m,x)-g),t.set(m,x+1,t.get(m,x+1)-g*E)}}}if(d!==0){for(o=r-1;o>=0;o--)if(g=s[o],E=e[o],E===0)for(V=o,n.set(o,o,1),m=o-1;m>=0;m--){for(O=n.get(m,m)-g,q=0,L=V;L<=o;L++)q=q+n.get(m,L)*n.get(L,o);if(e[m]<0)v=O,M=q;else if(V=m,e[m]===0?n.set(m,o,O!==0?-q/O:-q/(u*d)):(B=n.get(m,m+1),et=n.get(m+1,m),E=(s[m]-g)*(s[m]-g)+e[m]*e[m],nt=(B*M-v*q)/E,n.set(m,o,nt),n.set(m+1,o,Math.abs(B)>Math.abs(v)?(-q-O*nt)/B:(-M-et*nt)/v)),nt=Math.abs(n.get(m,o)),u*nt*nt>1)for(L=m;L<=o;L++)n.set(L,o,n.get(L,o)/nt)}else if(E<0)for(V=o-1,Math.abs(n.get(o,o-1))>Math.abs(n.get(o-1,o))?(n.set(o-1,o-1,E/n.get(o,o-1)),n.set(o-1,o,-(n.get(o,o)-g)/n.get(o,o-1))):(Z=Jt(0,-n.get(o-1,o),n.get(o-1,o-1)-g,E),n.set(o-1,o-1,Z[0]),n.set(o-1,o,Z[1])),n.set(o,o-1,0),n.set(o,o,1),m=o-2;m>=0;m--){for(w=0,I=0,L=V;L<=o;L++)w=w+n.get(m,L)*n.get(L,o-1),I=I+n.get(m,L)*n.get(L,o);if(O=n.get(m,m)-g,e[m]<0)v=O,q=w,M=I;else if(V=m,e[m]===0?(Z=Jt(-w,-I,O,E),n.set(m,o-1,Z[0]),n.set(m,o,Z[1])):(B=n.get(m,m+1),et=n.get(m+1,m),D=(s[m]-g)*(s[m]-g)+e[m]*e[m]-E*E,C=(s[m]-g)*2*E,D===0&&C===0&&(D=u*d*(Math.abs(O)+Math.abs(E)+Math.abs(B)+Math.abs(et)+Math.abs(v))),Z=Jt(B*q-v*w+E*I,B*M-v*I-E*w,D,C),n.set(m,o-1,Z[0]),n.set(m,o,Z[1]),Math.abs(B)>Math.abs(v)+Math.abs(E)?(n.set(m+1,o-1,(-w-O*n.get(m,o-1)+E*n.get(m,o))/B),n.set(m+1,o,(-I-O*n.get(m,o)-E*n.get(m,o-1))/B)):(Z=Jt(-q-et*n.get(m,o-1),-M-et*n.get(m,o),v,E),n.set(m+1,o-1,Z[0]),n.set(m+1,o,Z[1]))),nt=Math.max(Math.abs(n.get(m,o-1)),Math.abs(n.get(m,o))),u*nt*nt>1)for(L=m;L<=o;L++)n.set(L,o-1,n.get(L,o-1)/nt),n.set(L,o,n.get(L,o)/nt)}for(m=0;m<r;m++)if(m<i||m>l)for(L=m;L<r;L++)t.set(m,L,n.get(m,L));for(L=r-1;L>=i;L--)for(m=i;m<=l;m++){for(v=0,x=i;x<=Math.min(L,l);x++)v=v+t.get(m,x)*n.get(x,L);t.set(m,L,v)}}}function Jt(r,e,s,t){let n,o;return Math.abs(s)>Math.abs(t)?(n=t/s,o=s+n*t,[(r+n*e)/o,(e-n*r)/o]):(n=s/t,o=t+n*s,[(n*r+e)/o,(n*e-r)/o])}class ye{constructor(e){if(e=pt.checkMatrix(e),!e.isSymmetric())throw new Error("Matrix is not symmetric");let s=e,t=s.rows,n=new P(t,t),o=!0,i,l,u;for(l=0;l<t;l++){let h=0;for(u=0;u<l;u++){let d=0;for(i=0;i<u;i++)d+=n.get(u,i)*n.get(l,i);d=(s.get(l,u)-d)/n.get(u,u),n.set(l,u,d),h=h+d*d}for(h=s.get(l,l)-h,o&&=h>0,n.set(l,l,Math.sqrt(Math.max(h,0))),u=l+1;u<t;u++)n.set(l,u,0)}this.L=n,this.positiveDefinite=o}isPositiveDefinite(){return this.positiveDefinite}solve(e){e=pt.checkMatrix(e);let s=this.L,t=s.rows;if(e.rows!==t)throw new Error("Matrix dimensions do not match");if(this.isPositiveDefinite()===!1)throw new Error("Matrix is not positive definite");let n=e.columns,o=e.clone(),i,l,u;for(u=0;u<t;u++)for(l=0;l<n;l++){for(i=0;i<u;i++)o.set(u,l,o.get(u,l)-o.get(i,l)*s.get(u,i));o.set(u,l,o.get(u,l)/s.get(u,u))}for(u=t-1;u>=0;u--)for(l=0;l<n;l++){for(i=u+1;i<t;i++)o.set(u,l,o.get(u,l)-o.get(i,l)*s.get(i,u));o.set(u,l,o.get(u,l)/s.get(u,u))}return o}get lowerTriangularMatrix(){return this.L}}class be{constructor(e,s={}){e=pt.checkMatrix(e);let{Y:t}=s;const{scaleScores:n=!1,maxIterations:o=1e3,terminationCriteria:i=1e-10}=s;let l;if(t){if(f.isAnyArray(t)&&typeof t[0]=="number"?t=P.columnVector(t):t=pt.checkMatrix(t),t.rows!==e.rows)throw new Error("Y should have the same number of rows as X");l=t.getColumnVector(0)}else l=e.getColumnVector(0);let u=1,h,d,g,E;for(let q=0;q<o&&u>i;q++)g=e.transpose().mmul(l).div(l.transpose().mmul(l).get(0,0)),g=g.div(g.norm()),h=e.mmul(g).div(g.transpose().mmul(g).get(0,0)),q>0&&(u=h.clone().sub(E).pow(2).sum()),E=h.clone(),t?(d=t.transpose().mmul(h).div(h.transpose().mmul(h).get(0,0)),d=d.div(d.norm()),l=t.mmul(d).div(d.transpose().mmul(d).get(0,0))):l=h;if(t){let q=e.transpose().mmul(h).div(h.transpose().mmul(h).get(0,0));q=q.div(q.norm());let M=e.clone().sub(h.clone().mmul(q.transpose())),v=l.transpose().mmul(h).div(h.transpose().mmul(h).get(0,0)),N=t.clone().sub(h.clone().mulS(v.get(0,0)).mmul(d.transpose()));this.t=h,this.p=q.transpose(),this.w=g.transpose(),this.q=d,this.u=l,this.s=h.transpose().mmul(h),this.xResidual=M,this.yResidual=N,this.betas=v}else this.w=g.transpose(),this.s=h.transpose().mmul(h).sqrt(),n?this.t=h.clone().div(this.s.get(0,0)):this.t=h,this.xResidual=e.sub(h.mmul(g.transpose()))}}return Y.AbstractMatrix=U,Y.CHO=ye,Y.CholeskyDecomposition=ye,Y.DistanceMatrix=At,Y.EVD=de,Y.EigenvalueDecomposition=de,Y.LU=Kt,Y.LuDecomposition=Kt,Y.Matrix=P,Y.MatrixColumnSelectionView=Ue,Y.MatrixColumnView=Ge,Y.MatrixFlipColumnView=Ae,Y.MatrixFlipRowView=Ye,Y.MatrixRowSelectionView=Qe,Y.MatrixRowView=Ke,Y.MatrixSelectionView=Yt,Y.MatrixSubView=Je,Y.MatrixTransposeView=Xe,Y.NIPALS=be,Y.Nipals=be,Y.QR=ie,Y.QrDecomposition=ie,Y.SVD=qt,Y.SingularValueDecomposition=qt,Y.SymmetricMatrix=Ct,Y.WrapperMatrix1D=we,Y.WrapperMatrix2D=pt,Y.correlation=rs,Y.covariance=os,Y.default=P,Y.determinant=Qt,Y.inverse=He,Y.linearDependencies=ss,Y.pseudoInverse=ns,Y.solve=pe,Y.wrap=Ze,Y}var Ut=Os(),_e=Fs(Ut);const $s=Ut.EigenvalueDecomposition,je=Ut.Matrix;_e.Matrix?_e.Matrix:Ut.Matrix;const ve=Ut.inverse;function Bs(f,c=10,a=!1){const{K:p,M:y,numDOF:_}=f,k=new je(p),b=new je(y),S=1e-10;for(let K=0;K<_;K++)b.set(K,K,b.get(K,K)+S);let j;try{j=ve(b)}catch{for(let K=0;K<_;K++)b.set(K,K,b.get(K,K)+1e-6);j=ve(b)}const F=j.mmul(k),T=F.add(F.transpose()).mul(.5),R=new $s(T),z=R.realEigenvalues.map((K,ht)=>({idx:ht,val:K}));z.sort((K,ht)=>K.val-ht.val);const $=1e-4,A=z.filter(K=>K.val>$),X=A.slice(0,Math.min(c,A.length)),J=X.map(K=>K.val),tt=J.map(K=>Math.sqrt(Math.max(0,K))/(2*Math.PI));let ut;if(a){const K=R.eigenvectorMatrix;ut=X.map(ht=>K.getColumn(ht.idx))}return{eigenvalues:J,frequencies:tt,eigenvectors:ut}}function Fe(f,c){return new Promise(a=>{f.addEventListener("message",function p({data:y}){y?.type===c&&(f.removeEventListener("message",p),a(y))})})}Fe(self,"wasm_bindgen_worker_init").then(async({init:f,receiver:c})=>{const a=await Promise.resolve().then(function(){return Hs});await a.default(f),postMessage({type:"wasm_bindgen_worker_ready"}),a.wbg_rayon_start_worker(c)});async function Vs(f,c,a){if(a.numThreads()===0)throw new Error("num_threads must be > 0.");const p={type:"wasm_bindgen_worker_init",init:{module_or_path:f,memory:c},receiver:a.receiver()};await Promise.all(Array.from({length:a.numThreads()},async()=>{const y=new Worker(new URL("/multi-modal-tuning/assets/workerHelpers-BsCiD9Tk.js",import.meta.url),{type:"module"});return y.postMessage(p),await Fe(y,"wasm_bindgen_worker_ready"),y})),a.build()}let H;function Wt(f){const c=H.__externref_table_alloc();return H.__wbindgen_externrefs.set(c,f),c}function Le(f,c){return f=f>>>0,qe().subarray(f/8,f/8+c)}let zt=null;function qe(){return(zt===null||zt.buffer!==H.memory.buffer)&&(zt=new Float64Array(H.memory.buffer)),zt}function le(f,c){return f=f>>>0,Ys(f,c)}let Ot=null;function Gs(){return(Ot===null||Ot.buffer!==H.memory.buffer)&&(Ot=new Uint8Array(H.memory.buffer)),Ot}function Us(f,c){try{return f.apply(this,c)}catch(a){const p=Wt(a);H.__wbindgen_exn_store(p)}}function Xt(f){return f==null}function ae(f,c){const a=c(f.length*8,8)>>>0;return qe().set(f,a/8),ee=f.length,a}let $t=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):void 0;$t&&$t.decode();const As=2146435072;let ue=0;function Ys(f,c){return ue+=c,ue>=As&&($t=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),$t.decode(),ue=c),$t.decode(Gs().slice(f,f+c))}let ee=0;typeof FinalizationRegistry>"u"||new FinalizationRegistry(f=>H.__wbg_fem3dresult_free(f>>>0,1));const ke=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(f=>H.__wbg_wbg_rayon_poolbuilder_free(f>>>0,1));function Pe(f,c,a,p,y,_,k,b,S,j,F,T){const R=ae(f,H.__wbindgen_malloc),W=ee,z=ae(p,H.__wbindgen_malloc),$=ee,A=H.batch_compute_fitness(R,W,c,a,z,$,y,_,k,b,S,j,F,T);var X=Le(A[0],A[1]).slice();return H.__wbindgen_free(A[0],A[1]*8,8),X}function Ne(f,c,a,p,y,_,k,b,S){const j=ae(f,H.__wbindgen_malloc),F=ee,T=H.compute_frequencies_from_genes(j,F,c,a,p,y,_,k,b,S);var R=Le(T[0],T[1]).slice();return H.__wbindgen_free(T[0],T[1]*8,8),R}function De(f){return H.initThreadPool(f)}class Dt{static __wrap(c){c=c>>>0;const a=Object.create(Dt.prototype);return a.__wbg_ptr=c,ke.register(a,a.__wbg_ptr,a),a}__destroy_into_raw(){const c=this.__wbg_ptr;return this.__wbg_ptr=0,ke.unregister(this),c}free(){const c=this.__destroy_into_raw();H.__wbg_wbg_rayon_poolbuilder_free(c,0)}numThreads(){return H.wbg_rayon_poolbuilder_numThreads(this.__wbg_ptr)>>>0}build(){H.wbg_rayon_poolbuilder_build(this.__wbg_ptr)}receiver(){return H.wbg_rayon_poolbuilder_receiver(this.__wbg_ptr)>>>0}}Symbol.dispose&&(Dt.prototype[Symbol.dispose]=Dt.prototype.free);function Ks(f){H.wbg_rayon_start_worker(f)}const Qs=new Set(["basic","cors","default"]);async function Js(f,c){if(typeof Response=="function"&&f instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(f,c)}catch(p){if(f.ok&&Qs.has(f.type)&&f.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",p);else throw p}const a=await f.arrayBuffer();return await WebAssembly.instantiate(a,c)}else{const a=await WebAssembly.instantiate(f,c);return a instanceof WebAssembly.Instance?{instance:a,module:f}:a}}function Xs(f){const c={};return c.wbg={},c.wbg.__wbg___wbindgen_is_undefined_f6b95eab589e0269=function(a){return a===void 0},c.wbg.__wbg___wbindgen_memory_a342e963fbcabd68=function(){return H.memory},c.wbg.__wbg___wbindgen_module_967adef62ea6cbf8=function(){return ne.__wbindgen_wasm_module},c.wbg.__wbg___wbindgen_throw_dd24417ed36fc46e=function(a,p){throw new Error(le(a,p))},c.wbg.__wbg_call_abb4ff46ce38be40=function(){return Us(function(a,p){return a.call(p)},arguments)},c.wbg.__wbg_instanceof_Window_b5cf7783caa68180=function(a){let p;try{p=a instanceof Window}catch{p=!1}return p},c.wbg.__wbg_log_1d990106d99dacb7=function(a){console.log(a)},c.wbg.__wbg_new_no_args_cb138f77cf6151ee=function(a,p){return new Function(le(a,p))},c.wbg.__wbg_startWorkers_2ca11761e08ff5d5=function(a,p,y){return Vs(a,p,Dt.__wrap(y))},c.wbg.__wbg_static_accessor_GLOBAL_769e6b65d6557335=function(){const a=typeof global>"u"?null:global;return Xt(a)?0:Wt(a)},c.wbg.__wbg_static_accessor_GLOBAL_THIS_60cf02db4de8e1c1=function(){const a=typeof globalThis>"u"?null:globalThis;return Xt(a)?0:Wt(a)},c.wbg.__wbg_static_accessor_SELF_08f5a74c69739274=function(){const a=typeof self>"u"?null:self;return Xt(a)?0:Wt(a)},c.wbg.__wbg_static_accessor_WINDOW_a8924b26aa92d024=function(){const a=typeof window>"u"?null:window;return Xt(a)?0:Wt(a)},c.wbg.__wbindgen_cast_2241b6af4c4b2941=function(a,p){return le(a,p)},c.wbg.__wbindgen_init_externref_table=function(){const a=H.__wbindgen_externrefs,p=a.grow(4);a.set(0,void 0),a.set(p+0,void 0),a.set(p+1,null),a.set(p+2,!0),a.set(p+3,!1)},c.wbg.memory=f||new WebAssembly.Memory({initial:18,maximum:16384,shared:!0}),c}function Zs(f,c,a){if(H=f.exports,ne.__wbindgen_wasm_module=c,zt=null,Ot=null,typeof a<"u"&&(typeof a!="number"||a===0||a%65536!==0))throw"invalid stack size";return H.__wbindgen_start(a),H}async function ne(f,c){if(H!==void 0)return H;let a;typeof f<"u"&&(Object.getPrototypeOf(f)===Object.prototype?{module_or_path:f,memory:c,thread_stack_size:a}=f:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof f>"u"&&(f=new URL("/multi-modal-tuning/assets/wasm_physics_bg-4ZGpg7iK.wasm",import.meta.url));const p=Xs(c);(typeof f=="string"||typeof Request=="function"&&f instanceof Request||typeof URL=="function"&&f instanceof URL)&&(f=fetch(f));const{instance:y,module:_}=await Js(await f,p);return Zs(y,_,a)}var Hs=Object.freeze({__proto__:null,batch_compute_fitness:Pe,compute_frequencies_from_genes:Ne,default:ne,initThreadPool:De,wbg_rayon_PoolBuilder:Dt,wbg_rayon_start_worker:Ks});let Vt=!1,he=null,Te=!1,te=0;function tn(){try{return typeof SharedArrayBuffer<"u"}catch{return!1}}function en(){return te}async function sn(f=0){Vt||(he||(he=(async()=>{if(await ne(),tn())try{const c=navigator.hardwareConcurrency||4,a=f>0?Math.min(f,c):c;console.log(`Attempting to initialize thread pool with ${a} threads (maxCores=${f}, available=${c})...`),await De(a),Te=!0,te=a,console.log(`WASM physics module initialized with ${a} threads`)}catch(c){console.error("Failed to initialize thread pool:",c),c instanceof Error&&(console.error("Error name:",c.name),console.error("Error message:",c.message),console.error("Error stack:",c.stack)),Te=!1,te=1,console.log("WASM physics module initialized (single-threaded fallback)")}else te=1,console.log("WASM physics module initialized (single-threaded, SharedArrayBuffer not available)");Vt=!0})()),await he)}function Gt(){return Vt}function nn(f,c,a,p,y,_,k,b,S){if(!Vt)throw new Error("WASM not initialized. Call initWasm() first.");return Array.from(Ne(new Float64Array(f),c,a,p,y,_,k,b,S))}function on(f,c,a,p,y,_,k,b,S,j,F,T=1){if(!Vt)throw new Error("WASM not initialized. Call initWasm() first.");return Array.from(Pe(new Float64Array(f),c,a,new Float64Array(p),y,_,k,b,S,j,F,T))}function rn(f,c,a,p=10,y=150){const _=Cs(f,c,a,y);return Bs(_,p,!1).frequencies}function ln(f,c){const a=c*2;return f.length>a?f[a]:0}function oe(f,c,a,p=10,y=150,_){const k=_??Math.floor(f.length/2),b=ln(f,k),S=b!==0?{...c,L:c.L-2*b}:c,j=f.slice(0,k*2);if(Gt())return nn(j,S.L,S.b,S.h0,y,a.E,a.rho,a.nu,p);const F=se(j);return rn(F,S,a,p,y)}let ce=0,Ie=0,Zt=0;function un(f,c,a,p,y=150,_=1,k){if(f.length===0)return[];const b=k??Math.floor(f[0].length/2),S=f[0].length>b*2;if(S||!Gt()){Ie++;const $=Date.now();if($-Zt>2e3){const A=S?"length trim enabled":`WASM ready: ${Gt()}`;console.log(`Batch fitness: using per-individual computation (${A}, calls: JS=${Ie}, WASM=${ce})`),Zt=$}return f.map(A=>{const X=oe(A,c,a,p.length,y,b);let J=0,tt=0;for(let ut=0;ut<p.length;ut++){const K=ut===0?_:1,ht=(X[ut]-p[ut])/p[ut];J+=K*ht*ht,tt+=K}return tt>0?100*J/tt:1/0})}ce++;const j=f[0].length,F=f.flat();ce===1&&console.log(`WASM batch: f1Priority = ${_}`);const T=performance.now(),R=on(F,f.length,j,p,c.L,c.b,c.h0,y,a.E,a.rho,a.nu,_),W=performance.now()-T,z=Date.now();if(z-Zt>2e3){const $=W/f.length;console.log(`WASM batch: ${f.length} individuals in ${W.toFixed(1)}ms (${$.toFixed(2)}ms/ind)`),Zt=z}return R}function xe(f,c,a){if(f.length===0)return 0;const p=[...f].sort((S,j)=>j.lambda-S.lambda),y=c/2*a;let _=0,k=0;for(let S=p.length-1;S>=0;S--){const j=p[S];if(j.lambda>k&&j.lambda>0){const F=j.lambda-k,T=a-j.h;_+=F*T,k=j.lambda}}const b=100*(_/y);return Math.max(0,Math.min(100,b))}function We(f,c){if(f.length===0)return 0;const a=[...f].sort((k,b)=>b.lambda-k.lambda);let p=0,y=0;a.length>0&&(p+=Math.abs(c-a[0].h),y++);for(let k=1;k<a.length;k++)a[k].lambda<a[k-1].lambda&&(p+=Math.abs(a[k-1].h-a[k].h),y++);return y===0?0:100*(p/(y*c))}function hn(f,c,a=1){const p=Math.min(f.length,c.length);if(p===0)return 1/0;let y=0,_=0;for(let k=0;k<p;k++){const b=f[k],S=c[k];if(S===0)continue;const j=k===0?a:1,F=(b-S)/S;y+=j*F*F,_+=j}return _>0?100*(y/_):1/0}function cn(f,c,a){return(1-a)*f+a*c}function fn(f,c,a){return(1-a)*f+a*c}function an(f,c,a,p,y,_,k=150){const b=se(f),S=oe(f,c,a,p.length,k),j=hn(S,p),F=xe(b,c.L,c.h0),T=We(b,c.h0);let R=j;y==="volume"&&_>0?R=cn(j,F,_):y==="roughness"&&_>0&&(R=fn(j,T,_));const W=S.map(($,A)=>{const X=p[A];return!X||X===0?0:1200*Math.log2($/X)}),z=Math.max(...W.map(Math.abs));return{computedFrequencies:S,targetFrequencies:p,tuningError:j,volumePenalty:F,roughnessPenalty:T,combinedFitness:R,centsErrors:W,maxCentsError:z}}function gn(f,c){const a=f.filter(j=>isFinite(j.fitness)&&j.fitness>0);if(a.length===0)return Array.from({length:c},()=>f[Math.floor(Math.random()*f.length)]);const p=a.map(j=>1/j.fitness),y=p.reduce((j,F)=>j+F,0),_=p.map(j=>j/y),k=[];let b=0;for(const j of _)b+=j,k.push(b);const S=[];for(let j=0;j<c;j++){const F=Math.random();let T=0;for(let R=0;R<k.length;R++)if(F<=k[R]){T=R;break}S.push(a[T])}return S}function mn(f,c,a=3){const p=[];for(let y=0;y<c;y++){const _=[];for(let b=0;b<a;b++){const S=Math.floor(Math.random()*f.length);_.push(f[S])}const k=_.reduce((b,S)=>S.fitness<b.fitness?S:b);p.push(k)}return p}function wn(f,c,a=1.5){const p=[...f].sort((T,R)=>T.fitness-R.fitness),y=p.length,_=p.map((T,R)=>{const W=R;return(2-a)/y+2*(a-1)*(y-1-W)/(y*(y-1))}),k=_.reduce((T,R)=>T+R,0),b=_.map(T=>T/k),S=[];let j=0;for(const T of b)j+=T,S.push(j);const F=[];for(let T=0;T<c;T++){const R=Math.random();let W=0;for(let z=0;z<S.length;z++)if(R<=S[z]){W=z;break}F.push(p[W])}return F}function pn(f,c,a="roulette"){const p=[],y={roulette:(_,k)=>gn(_,k),tournament:(_,k)=>mn(_,k),rank:(_,k)=>wn(_,k)}[a];for(let _=0;_<c;_++){const[k]=y(f,1);let b,S=0;do[b]=y(f,1),S++;while(b===k&&S<10);p.push([k,b])}return p}function dn(f,c){return[...f].sort((p,y)=>p.fitness-y.fitness).slice(0,c).map(p=>({genes:[...p.genes],fitness:p.fitness,sigmas:p.sigmas?[...p.sigmas]:void 0}))}function yn(f,c,a){const p=f.genes.length,y=Math.random(),_=new Array(p),k=new Array(p);for(let T=0;T<p;T++){const R=f.genes[T],W=c.genes[T];_[T]=R+y*(W-R),k[T]=W+y*(R-W)}const b=Nt(_,a),S=Nt(k,a);let j,F;return f.sigmas&&c.sigmas&&(j=f.sigmas.map((T,R)=>{const W=c.sigmas[R];return T+y*(W-T)}),F=c.sigmas.map((T,R)=>{const W=f.sigmas[R];return T+y*(W-T)})),[{genes:b,fitness:1/0,sigmas:j},{genes:S,fitness:1/0,sigmas:F}]}function bn(f,c,a){const p=[...f.genes],y=p.length,_=Math.floor(Math.random()*y)+1,k=new Set;for(;k.size<_;)k.add(Math.floor(Math.random()*y));const b=a.maxLengthTrim>0||a.maxLengthExtend>0,j=Math.floor(b?(y-1)/2:y/2)*2;for(const T of k){let R;b&&T===j?R=a.maxLengthTrim+a.maxLengthExtend:R=T%2===0?a.lambdaMax-a.lambdaMin:a.hMax-a.hMin;const W=Math.random()*2-1;p[T]+=c*R*W}return{genes:Nt(p,a),fitness:1/0,sigmas:f.sigmas?[...f.sigmas]:void 0}}function Mn(f,c,a,p,y=.7){const _=[...f.genes],k=_.length,b=Math.floor(Math.random()*k)+1,S=new Set;for(;S.size<b;)S.add(Math.floor(Math.random()*k));const j=a.maxLengthTrim>0||a.maxLengthExtend>0,R=Math.floor(j?(k-1)/2:k/2)*2;for(const z of S){let $;if(j&&z===R)if($=a.maxLengthTrim+a.maxLengthExtend,p&&Math.abs(p.f1Error)>.001){const A=p.f1Error<0?1:-1;let X;Math.random()<y?X=A*Math.random():X=Math.random()*2-1,_[z]+=c*$*X}else{const A=Math.random()*2-1;_[z]+=c*$*A}else{$=z%2===0?a.lambdaMax-a.lambdaMin:a.hMax-a.hMin;const X=Math.random()*2-1;_[z]+=c*$*X}}return{genes:Nt(_,a),fitness:1/0,sigmas:f.sigmas?[...f.sigmas]:void 0}}function Re(f,c,a,p,y,_){try{const k=ge(f,_),b=oe(f,c,a,p.length,y,_),S=b.map((j,F)=>{const T=p[F];return!T||T===0?0:1200*Math.log2(j/T)});return{computedFrequencies:b,errorsInCents:S,lengthTrim:k}}catch{return{computedFrequencies:[],errorsInCents:[],lengthTrim:0}}}function fe(f,c,a,p,y,_,k,b=1,S=1){const j=f.map(T=>T.genes),F=un(j,c,a,p,k,b,S);return f.map((T,R)=>{let W=F[R];if(y!=="none"&&_>0){const z=T.genes.slice(0,S*2),$=se(z),A=ge(T.genes,S),X=c.L-2*A;if(y==="volume"){const J=xe($,X,c.h0);W=(1-_)*W+_*J}else{const J=We($,c.h0);W=(1-_)*W+_*J}}return{...T,fitness:W}})}async function En(f){const{bar:c,material:a,targetFrequencies:p,numCuts:y,penaltyType:_,penaltyWeight:k,eaParams:b,seedGenes:S,onProgress:j,shouldStop:F}=f,T=bs(c,y,{minCutWidth:b.minCutWidth??0,maxCutWidth:b.maxCutWidth??0,minCutDepth:b.minCutDepth??0,maxCutDepth:b.maxCutDepth??0,maxLengthTrim:b.maxLengthTrim??0,maxLengthExtend:b.maxLengthExtend??0}),R=b.f1Priority??1,W=(b.maxLengthTrim??0)>0||(b.maxLengthExtend??0)>0;if(j){const bt=Ms(y,T,c.h0),[Mt]=fe([bt],c,a,p,_,k,b.numElements,R,y),{computedFrequencies:mt,errorsInCents:Tt,lengthTrim:It}=Re(Mt.genes,c,a,p,b.numElements,y);j({generation:0,bestFitness:Mt.fitness,bestIndividual:Mt,averageFitness:Mt.fitness,computedFrequencies:mt,errorsInCents:Tt,lengthTrim:It})}let z=Ss(b.populationSize,y,T,S);z=fe(z,c,a,p,_,k,b.numElements,R,y);const $=Math.max(1,Math.floor(b.populationSize*b.elitismPercent/100)),A=Math.floor(b.populationSize*b.crossoverPercent/100),X=Math.ceil(A/2);let J=Me(z),tt=0;for(;tt<b.maxGenerations&&!(F?.()||J.fitness<=b.targetError);){const bt=[],Mt=dn(z,$);bt.push(...Mt);const mt=[];if(A>0){const at=pn(z,X,"roulette");for(const[wt,Et]of at){const[Rt,Lt]=yn(wt,Et,T);mt.push(Rt),bt.length+mt.length<b.populationSize&&mt.push(Lt)}}const Tt=[...z].sort((at,wt)=>at.fitness-wt.fitness);for(;bt.length+mt.length<b.populationSize;){const at=Math.floor(Math.random()*Math.min(Tt.length,$+A)),wt=Tt[at];let Et;if(W){const re={f1Error:oe(wt.genes,c,a,1,b.numElements,y)[0]-p[0]};Et=Mn(wt,b.mutationStrength,T,re)}else Et=bn(wt,b.mutationStrength,T);mt.push(Et)}if(mt.length>0){const at=fe(mt,c,a,p,_,k,b.numElements,R,y);bt.push(...at)}z=bt;const It=Me(z);if(It.fitness<J.fitness&&(J=Ee(It)),tt++,j){const at=_s(z),{computedFrequencies:wt,errorsInCents:Et,lengthTrim:Rt}=Re(J.genes,c,a,p,b.numElements,y);j({generation:tt,bestFitness:J.fitness,bestIndividual:Ee(J),averageFitness:at.averageFitness,computedFrequencies:wt,errorsInCents:Et,lengthTrim:Rt})}await new Promise(at=>setTimeout(at,0))}const ut=ge(J.genes,y),K=c.L-2*ut,ht=ut!==0?{...c,L:K}:c,Ft=J.genes.slice(0,y*2),gt=an(Ft,ht,a,p,_,k,b.numElements);return{bestIndividual:J,cuts:se(Ft),computedFrequencies:gt.computedFrequencies,targetFrequencies:gt.targetFrequencies,tuningError:gt.tuningError,maxErrorCents:gt.maxCentsError,errorsInCents:gt.centsErrors,volumePercent:gt.volumePenalty,roughnessPercent:gt.roughnessPenalty,generations:tt,lengthTrim:ut,effectiveLength:K}}let Pt=!1,ze=!1,Oe=null,Ht=null;async function Sn(f){if(Ht){await Ht;return}Ht=sn(f).then(()=>{ze=!0;const c=en();console.log(`Worker: WASM initialized successfully with ${c} threads, isWasmReady():`,Gt())}).catch(c=>{Oe=c,console.warn("Worker: WASM initialization failed, using JS fallback:",c)}),await Ht}self.onmessage=async f=>{const c=f.data;switch(c.type){case"START":Pt=!1;const a=c.params.eaParams.maxCores??0;console.log(`Worker: START received, initializing WASM with maxCores=${a}...`),await Sn(a),console.log("Worker: WASM init complete. wasmInitialized:",ze,"isWasmReady():",Gt()),Oe&&console.log("Worker: WASM had error, falling back to JS"),_n(c.params);break;case"STOP":Pt=!0,postMessage({type:"STOPPED"});break;case"PAUSE":Pt=!0;break;case"RESUME":Pt=!1;break}};async function _n(f){try{const c={bar:f.bar,material:f.material,targetFrequencies:f.targetFrequencies,numCuts:f.numCuts,penaltyType:f.penaltyType,penaltyWeight:f.penaltyWeight,eaParams:f.eaParams,seedGenes:f.seedGenes,onProgress:p=>{postMessage({type:"PROGRESS",data:p})},shouldStop:()=>Pt},a=await En(c);Pt||postMessage({type:"COMPLETE",result:a})}catch(c){postMessage({type:"ERROR",message:c instanceof Error?c.message:"Unknown error"})}}
